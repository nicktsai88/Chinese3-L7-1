<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>張釋之執法 - 互動學習 App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom Animations */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .animate-confetti {
            animation-name: confetti-fall;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Mock Icons (SVG Components) ---
        // Since we are in a single file without a bundler, we define icons manually to avoid dependency issues.
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            PenTool: (props) => <Icon {...props} path={<><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></>} />,
            History: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l3 3"/></>} />,
            Heart: (props) => <Icon {...props} path={<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            CheckCircle: (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            XCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />,
            ChevronRight: (props) => <Icon {...props} path={<path d="m9 18 6-6-6-6"/>} />,
            LogOut: (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            User: (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            ArrowLeft: (props) => <Icon {...props} path={<><line x1="19" x2="5" y1="12" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
            Zap: (props) => <Icon {...props} path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />,
            Home: (props) => <Icon {...props} path={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} />,
            LayoutGrid: (props) => <Icon {...props} path={<><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></>} />,
            Layers: (props) => <Icon {...props} path={<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>} />,
            ChevronDown: (props) => <Icon {...props} path={<path d="m6 9 6 6 6-6"/>} />,
            ChevronUp: (props) => <Icon {...props} path={<path d="m18 15-6-6-6 6"/>} />,
            Loader2: (props) => <Icon {...props} path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} />,
            Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></>} />,
            Image: (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />
        };

        // --- Local Storage Helper ---
        const DB = {
            getUser: () => JSON.parse(localStorage.getItem('zs_user')),
            setUser: (user) => localStorage.setItem('zs_user', JSON.stringify(user)),
            clearUser: () => localStorage.removeItem('zs_user'),
            
            getHistory: () => JSON.parse(localStorage.getItem('zs_history') || '[]'),
            addHistory: (record) => {
                const history = DB.getHistory();
                history.unshift({ ...record, id: Date.now() }); // Add ID for key
                localStorage.setItem('zs_history', JSON.stringify(history));
            },
            
            getMistakes: () => JSON.parse(localStorage.getItem('zs_mistakes') || '[]'),
            addMistake: (question) => {
                let mistakes = DB.getMistakes();
                if (!mistakes.find(m => m.id === question.id)) {
                    mistakes.unshift({ ...question, timestamp: Date.now() });
                    localStorage.setItem('zs_mistakes', JSON.stringify(mistakes));
                }
            },
            removeMistake: (qId) => {
                const mistakes = DB.getMistakes().filter(m => m.id !== qId);
                localStorage.setItem('zs_mistakes', JSON.stringify(mistakes));
            },
            
            getFavorites: () => new Set(JSON.parse(localStorage.getItem('zs_favorites') || '[]')),
            toggleFavorite: (qId) => {
                const favs = DB.getFavorites();
                if (favs.has(qId)) favs.delete(qId);
                else favs.add(qId);
                localStorage.setItem('zs_favorites', JSON.stringify([...favs]));
                return favs;
            }
        };

        // --- Data Content ---
        const STUDY_CONTENT = {
            intro: {
                title: "形音義與題解",
                items: [
                    { term: "先河", definition: "借指開創於先的人，或指事物的本源。" },
                    { term: "直言抗辯", definition: "以正直的言論加以辯駁。" },
                    { term: "風骨", definition: "指人的品格、性格。" },
                    { term: "太史令", definition: "古官名，為史官之長，漢武帝設置，負責記載朝廷大事兼掌天文曆法。" },
                    { term: "宮刑", definition: "男子去勢的刑罰，亦稱為「腐刑」，約始於商周時。" },
                    { term: "報任少卿書", definition: "司馬遷所著：「行莫醜於辱先，而莫大於宮刑。」（詬，音 ㄍㄡˋ，恥辱。）" }
                ],
                author: {
                    title: "作者補充：司馬遷",
                    stages: [
                        "居家讀書期 (幼年~20歲)",
                        "壯遊南北期 (20歲~36歲)",
                        "繼志寫史期 (37~47歲)：38歲當太史令。42歲著手《史記》的著述。",
                        "忍辱著書期 (47~56歲)：47歲為李陵辯護而入獄，48歲為免死刑而接受宮刑。50歲出獄。漢武帝知道司馬遷是無辜的，升他為中書令。",
                        "晚年 (57~60歲)"
                    ],
                    motivation: "司馬遷出生於史官世家，父親司馬談是一位學識淵博的學者...欲「究天人之際，通古今之變，成一家之言」。"
                }
            },
            shiji: {
                title: "史記體例表格",
                description: "《史記》是中國史上首部紀傳體通史，共五十二萬六千餘字。",
                table: [
                    { category: "本紀", count: "十二卷", content: "記敘歷代帝王事蹟，是全書敘述的提綱。按時間記載帝王的世系和國家大事。", note: "破例收錄：項羽、呂后。", hasImage: true },
                    { category: "表", count: "十卷", content: "以時間為中心，用表格方式整理重大歷史事件。使歷史發展的脈絡更為明晰。", note: "—", hasImage: true },
                    { category: "書", count: "八卷", content: "記國家體制。對天文、曆法、經濟、文化、水利，以及典章制度作專門論述。", note: "—", hasImage: true },
                    { category: "世家", count: "三十卷", content: "記述貴族王侯及其子孫的歷史事蹟。多記述春秋、戰國時期各諸侯國興衰存亡的歷史。", note: "破例收錄：孔子、陳涉、外戚。", hasImage: true },
                    { category: "列傳", count: "七十卷", content: "列敘大臣至於平民各類人物的歷史表現。包含專傳、合傳、類傳。", note: "少數列傳記外國史和少數民族史。末篇《太史公自序》為自傳。", hasImage: true }
                ]
            },
            idioms: {
                title: "成語典故",
                items: [
                    { name: "燕雀安知鴻鵠之志", mean: "比喻一般人無法明白雄才大略者的遠大志向。", source: "《史記．陳涉世家》", hasImage: true },
                    { name: "桃李不言，下自成蹊", mean: "比喻只要為人真誠，自能感動別人，為人所敬仰。", source: "《史記．李將軍列傳》", hasImage: true },
                    { name: "不鳴則已，一鳴驚人", mean: "比喻人平時沒有特殊表現、默默無聞，一旦施展才華，即能做出非凡的成果。", source: "《史記．淳于髡傳》", hasImage: true },
                    { name: "運籌帷幄之中，決勝千里之外", mean: "說明某人善於謀略及指揮。", source: "《史記．高祖本紀》", hasImage: true },
                    { name: "無顏見江東父老", mean: "指心懷羞愧，沒臉見自己人。", source: "《史記．項羽本紀》", hasImage: true }
                ]
            },
            grammar: {
                title: "課文詞語與語法",
                items: [
                    { text: "釋之「為」廷尉", mean: "當、擔任", hasImage: true },
                    { text: "於是「使」騎捕", mean: "派遣" },
                    { text: "於是使「騎」捕", mean: "騎兵", hasImage: true },
                    { text: "「匿」橋下", mean: "隱藏", hasImage: true },
                    { text: "久「之」", mean: "助詞，無義" },
                    { text: "「即」出", mean: "便、就" },
                    { text: "「即」走耳", mean: "便、就" },
                    { text: "即走「耳」", mean: "矣、了" },
                    { text: "「當」罰金 / 「當」之罰金", mean: "判處", hasImage: true },
                    { text: "「親」驚吾馬", mean: "親自" },
                    { text: "法「者」", mean: "助詞，表示停頓" },
                    { text: "如此「而」更重之", mean: "卻 (亦可作假如)" },
                    { text: "更「重」之", mean: "加重" },
                    { text: "更重「之」", mean: "指罪" },
                    { text: "「是」法不信", mean: "此、這" },
                    { text: "不信「於」民", mean: "被" },
                    { text: "上「使」立誅之", mean: "假使 (或派人)" },
                    { text: "天下「之」平", mean: "的" },
                    { text: "「良」久", mean: "很、甚、極" },
                    { text: "廷尉「當」是也", mean: "判決" },
                    { text: "當「是」也", mean: "正確的" },
                    { text: "涇渭分明", mean: "比喻是非好壞區別得非常清楚", hasImage: true },
                    { text: "乘輿", mean: "皇帝/鑾駕", hasImage: true },
                    { text: "黔首", mean: "平民百姓 (黔：黑色)", hasImage: true }
                ]
            },
            honorifics: {
                title: "敬詞謙詞對照表",
                intro: "古時臣子對皇帝敬稱「陛下」，源於「陛」為正殿最高階。臣子謙稱「下臣」。",
                respect: [
                    { key: "令", words: "令尊(父)、令堂(母)、令郎(子)、令媛(女)" },
                    { key: "尊", words: "尊夫人(妻)、尊姓大名(姓名)" },
                    { key: "貴", words: "貴庚(年齡)、貴姓、貴校、貴公司、貴公館" },
                    { key: "賢", words: "賢喬梓(父子)、賢昆仲(兄弟)、賢伉儷(夫婦)" },
                    { key: "高", words: "高見、高就" }
                ],
                humble: [
                    { key: "家", words: "家父/家嚴、家母/家慈、家兄、家姊" },
                    { key: "舍", words: "舍弟、舍姪" },
                    { key: "敝", words: "敝人、敝校、敝公司、敝業師" },
                    { key: "拙", words: "拙見、拙著、拙荊(妻)" },
                    { key: "小", words: "小犬(子)、小女(女)、小店" },
                    { key: "薄", words: "薄禮、薄面" }
                ]
            }
        };

        const generateQuestions = () => {
            const q = [];
            let id = 1;
            // Intro
            q.push({ id: id++, category: "形音義與題解", question: "「先河」一詞的意思是？", options: ["河流的名字", "開創於先的人或事物本源", "已故的親人", "先進的河流技術"], answer: "開創於先的人或事物本源" });
            q.push({ id: id++, category: "形音義與題解", question: "「直言抗辯」的意思是？", options: ["大聲爭吵", "婉轉地拒絕", "以正直的言論加以辯駁", "直接放棄辯解"], answer: "以正直的言論加以辯駁" });
            q.push({ id: id++, category: "形音義與題解", question: "「風骨」是指人的什麼？", options: ["身體骨骼", "品格、性格", "穿著風格", "書法筆勁"], answer: "品格、性格" });
            q.push({ id: id++, category: "形音義與題解", question: "「太史令」的主要職責不包含下列何者？", options: ["記載朝廷大事", "掌天文", "掌曆法", "管理刑獄"], answer: "管理刑獄" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷受到的「宮刑」又稱為？", options: ["大辟", "腐刑", "墨刑", "劓刑"], answer: "腐刑" });
            // Shiji
            q.push({ id: id++, category: "史記體例表格", question: "《史記》是中國史上首部什麼體例的史書？", options: ["編年體通史", "紀傳體通史", "國別史", "斷代史"], answer: "紀傳體通史" });
            q.push({ id: id++, category: "史記體例表格", question: "《史記》中記載歷代帝王事蹟，屬於全書提綱的是哪一類？", options: ["世家", "列傳", "本紀", "表"], answer: "本紀" });
            // Idioms
            q.push({ id: id++, category: "成語典故", question: "「燕雀安知鴻鵠之志」比喻什麼？", options: ["朋友間的誤會", "一般人無法明白雄才大略者的遠大志向", "鳥類的習性不同", "地位高低無法溝通"], answer: "一般人無法明白雄才大略者的遠大志向" });
            q.push({ id: id++, category: "成語典故", question: "「桃李不言，下自成蹊」出自《史記》哪一篇？", options: ["項羽本紀", "陳涉世家", "李將軍列傳", "孔子世家"], answer: "《史記．李將軍列傳》" });
            // Grammar
            q.push({ id: id++, category: "課文詞語與語法", question: "「釋之為廷尉」的「為」字解釋為？", options: ["為了", "因為", "擔任", "被"], answer: "擔任" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「久之」的「之」字詞性與意義是？", options: ["代詞，指時間", "動詞，往", "助詞，無義", "介詞，的"], answer: "助詞，無義" });
            // Honorifics
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "稱呼對方的父親，應使用？", options: ["家父", "令尊", "尊翁", "舍親"], answer: "令尊" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "向他人介紹自己的妻子，應使用？", options: ["尊夫人", "賢內助", "拙荊", "令正"], answer: "拙荊" });
            
            return q;
        };

        const ALL_QUESTIONS = generateQuestions();

        // --- Main Components ---

        const LoadingScreen = () => (
            <div className="flex flex-col items-center justify-center h-screen bg-stone-50">
                <Icons.Loader2 className="animate-spin text-orange-500 mb-4 h-12 w-12" />
                <p className="text-stone-600">載入中...</p>
            </div>
        );

        const AuthScreen = ({ onLogin }) => {
            const [name, setName] = useState('');
            const [savedName, setSavedName] = useState('');

            useEffect(() => {
                const user = DB.getUser();
                if (user && user.name) {
                    setSavedName(user.name);
                }
            }, []);

            const handleLogin = (e, forcedName) => {
                if (e) e.preventDefault();
                const loginName = forcedName || name;
                if (!loginName.trim()) return;
                
                const userData = { name: loginName, loginTime: Date.now() };
                DB.setUser(userData);
                onLogin(userData);
            };

            const handleQuickLogin = () => {
                const randomNum = Math.floor(Math.random() * 1000);
                handleLogin(null, `訪客 ${randomNum}`);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-100 to-amber-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-orange-500">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 mx-auto mb-4 text-orange-600">
                                <Icons.BookOpen className="w-full h-full" />
                            </div>
                            <h1 className="text-3xl font-bold text-stone-800">張釋之執法</h1>
                            <p className="text-stone-500 mt-2">互動式學習 App</p>
                        </div>
                        
                        {savedName && (
                            <div className="mb-6">
                                <button
                                    onClick={() => handleLogin(null, savedName)}
                                    className="w-full bg-gradient-to-r from-orange-500 to-amber-500 text-white py-4 rounded-xl font-bold hover:from-orange-600 hover:to-amber-600 transition shadow-lg shadow-orange-200 flex items-center justify-center group"
                                >
                                    <Icons.Sparkles className="w-5 h-5 mr-2 animate-pulse text-yellow-200" />
                                    <span>以 {savedName} 繼續學習</span>
                                    <Icons.ChevronRight className="w-5 h-5 ml-2 group-hover:translate-x-1 transition" />
                                </button>
                                <div className="text-center mt-3">
                                    <button 
                                        onClick={() => { setSavedName(''); DB.clearUser(); }}
                                        className="text-xs text-stone-400 hover:text-stone-600 underline"
                                    >
                                        這不是我，切換帳號
                                    </button>
                                </div>
                                <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-stone-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-stone-500">或使用新身分</span></div></div>
                            </div>
                        )}

                        <form onSubmit={handleLogin} className={`space-y-4 ${savedName ? 'hidden' : ''}`}>
                            <div>
                                <label className="block text-sm font-medium text-stone-700 mb-1">請輸入您的姓名</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="Ex: 王小明" />
                            </div>
                            <button type="submit" disabled={!name.trim()} className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition disabled:opacity-50">
                                開始學習
                            </button>
                        </form>
                        
                        <div className={`mt-4 flex items-center justify-between ${savedName ? 'hidden' : ''}`}>
                           <div className="h-px bg-stone-200 flex-1"></div><span className="text-sm text-stone-400 px-2">或</span><div className="h-px bg-stone-200 flex-1"></div>
                        </div>
                        <button onClick={handleQuickLogin} className={`mt-4 w-full bg-stone-50 border-2 border-stone-200 text-stone-600 py-3 rounded-lg font-semibold hover:bg-stone-100 transition flex items-center justify-center ${savedName ? 'hidden' : ''}`}>
                            <Icons.Zap className="w-5 h-5 mr-2 text-yellow-500" /> 快速體驗 (免輸入姓名)
                        </button>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onNavigate, onLogout }) => {
            return (
                <div className="p-6 max-w-4xl mx-auto space-y-6">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-stone-800">歡迎回來，{user.name}</h1>
                            <p className="text-stone-500">準備好開始今天的學習了嗎？</p>
                        </div>
                        <button onClick={onLogout} className="text-stone-500 hover:text-red-500"><Icons.LogOut className="w-6 h-6" /></button>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onClick={() => onNavigate('learn')} className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition group border-l-4 border-orange-500 text-left">
                            <div className="flex items-center space-x-4 mb-2">
                                <div className="bg-orange-100 p-3 rounded-full group-hover:bg-orange-200 transition"><Icons.BookOpen className="w-8 h-8 text-orange-600" /></div>
                                <h2 className="text-xl font-bold text-stone-800">進入學習介面</h2>
                            </div>
                            <p className="text-stone-500 pl-16">瀏覽重點筆記、形音義、史記體例與成語典故。</p>
                        </button>

                        <button onClick={() => onNavigate('quiz_setup')} className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition group border-l-4 border-amber-500 text-left">
                            <div className="flex items-center space-x-4 mb-2">
                                <div className="bg-amber-100 p-3 rounded-full group-hover:bg-amber-200 transition"><Icons.PenTool className="w-8 h-8 text-amber-600" /></div>
                                <h2 className="text-xl font-bold text-stone-800">開始測驗</h2>
                            </div>
                            <p className="text-stone-500 pl-16">單元分類練習、挑戰全方位題庫，即時回饋。</p>
                        </button>
                    </div>

                    <div className="grid grid-cols-3 gap-4 mt-8">
                        <button onClick={() => onNavigate('history')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <Icons.History className="w-6 h-6 text-orange-500 mb-2" /><span className="text-sm font-medium text-stone-700">測驗紀錄</span>
                        </button>
                        <button onClick={() => onNavigate('mistakes')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <Icons.AlertCircle className="w-6 h-6 text-red-500 mb-2" /><span className="text-sm font-medium text-stone-700">錯題本</span>
                        </button>
                        <button onClick={() => onNavigate('favorites')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <Icons.Heart className="w-6 h-6 text-rose-500 mb-2" /><span className="text-sm font-medium text-stone-700">題目收藏</span>
                        </button>
                    </div>
                </div>
            );
        };

        const LearningModule = ({ onBack }) => {
            const [activeTab, setActiveTab] = useState('idioms'); 

            const tabs = [
                { id: 'intro', label: '形音義與題解' },
                { id: 'shiji', label: '史記體例' },
                { id: 'idioms', label: '成語典故' },
                { id: 'grammar', label: '詞語語法' },
                { id: 'honorifics', label: '敬謙詞' },
            ];

            const renderImage = (tabId, index) => {
                const imagePath = `images/${tabId}_${index}.jpg`;
                return (
                    <div className="mt-4 border-t border-dashed border-stone-200 pt-4">
                        <div className="relative group rounded-lg overflow-hidden bg-stone-100">
                            <img 
                                src={imagePath} 
                                alt="示意圖" 
                                className="w-full h-auto object-cover"
                                onError={(e) => {
                                    e.target.onerror = null;
                                    e.target.style.display = 'none';
                                    // Use vanilla JS to append fallback
                                    const fallback = document.createElement('div');
                                    fallback.className = "text-center text-stone-400 p-6 flex flex-col items-center";
                                    fallback.innerHTML = `<svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="text-sm">尚未放入圖片 (${imagePath})</span>`;
                                    e.target.parentElement.appendChild(fallback);
                                }}
                            />
                        </div>
                    </div>
                );
            };

            const handleDownloadAll = () => {
                alert('請確認 images 資料夾中已包含所有圖片：\n格式：idioms_0.jpg, shiji_1.jpg 等。');
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center justify-between sticky top-0 z-10">
                        <div className="flex items-center">
                            <button onClick={onBack} className="flex items-center text-stone-600 hover:text-orange-600">
                                <Icons.ArrowLeft className="w-5 h-5 mr-1" /> 返回
                            </button>
                            <div className="w-4"></div>
                            <h2 className="font-bold text-lg text-stone-800 hidden md:block">學習重點</h2>
                        </div>
                        <button onClick={handleDownloadAll} className="flex items-center px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition text-sm font-medium">
                            <Icons.Download className="w-4 h-4 mr-1.5" /> 圖片說明
                        </button>
                    </div>
                    
                    <div className="flex overflow-x-auto bg-stone-50 px-2 py-2 gap-2 sticky top-14 z-10 border-b">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${
                                    activeTab === tab.id 
                                        ? 'bg-orange-600 text-white shadow-md' 
                                        : 'bg-white text-stone-600 hover:bg-orange-50 border border-stone-200'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 md:p-6 bg-stone-100 pb-20">
                        <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-sm p-6 min-h-[500px]">
                            {/* Content Rendering based on Tab */}
                            {activeTab === 'intro' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.intro.title}</h3>
                                    <ul className="space-y-4">
                                        {STUDY_CONTENT.intro.items.map((item, i) => (
                                            <li key={i} className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                                <span className="font-bold text-orange-700 text-lg mr-2">{item.term}</span>
                                                <span className="text-stone-700">{item.definition}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}

                            {activeTab === 'shiji' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.shiji.title}</h3>
                                    <div className="grid gap-6">
                                        {STUDY_CONTENT.shiji.table.map((row, i) => (
                                            <div key={i} className="border border-stone-200 rounded-xl p-5 hover:shadow-md transition bg-white overflow-hidden">
                                                <div className="flex justify-between items-center mb-2">
                                                    <h4 className="font-bold text-xl text-indigo-700">{row.category}</h4>
                                                    <span className="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-bold">{row.count}</span>
                                                </div>
                                                <p className="text-stone-700 mb-3 leading-relaxed">{row.content}</p>
                                                {row.hasImage && renderImage('shiji', i)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'idioms' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.idioms.title}</h3>
                                    <div className="grid gap-6">
                                        {STUDY_CONTENT.idioms.items.map((item, i) => (
                                            <div key={i} className="border border-stone-200 rounded-xl p-5 hover:shadow-md transition bg-white overflow-hidden">
                                                <h4 className="font-bold text-xl text-emerald-700 mb-2">{item.name}</h4>
                                                <p className="text-stone-600 mb-3">{item.mean}</p>
                                                {item.hasImage && renderImage('idioms', i)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'grammar' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.grammar.title}</h3>
                                    <div className="grid gap-6">
                                        {STUDY_CONTENT.grammar.items.map((item, i) => (
                                            <div key={i} className="border border-stone-200 rounded-xl p-5 hover:shadow-md transition bg-white overflow-hidden">
                                                <div className="flex-1">
                                                    <div className="font-bold text-xl text-stone-800 mb-2">{item.text}</div>
                                                    <div className="text-orange-600 font-bold text-lg">→ {item.mean}</div>
                                                </div>
                                                {item.hasImage && renderImage('grammar', i)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'honorifics' && (
                                <div className="space-y-8">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.honorifics.title}</h3>
                                    <div>
                                        <h4 className="text-lg font-bold text-orange-700 mb-3 flex items-center">敬詞</h4>
                                        <div className="bg-white border rounded-lg overflow-hidden">
                                            {STUDY_CONTENT.honorifics.respect.map((row, i) => (
                                                <div key={i} className="flex border-b last:border-0">
                                                    <div className="w-16 bg-orange-50 p-3 flex items-center justify-center font-bold text-orange-800">{row.key}</div>
                                                    <div className="p-3 flex-1 text-stone-700">{row.words}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const QuizModule = ({ user, onBack, onComplete }) => {
            const [selectedCategory, setSelectedCategory] = useState(null); 
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [favorites, setFavorites] = useState(new Set());
            const [questions, setQuestions] = useState([]);
            const [isAnswered, setIsAnswered] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (!selectedCategory) return;
                let filtered = [...ALL_QUESTIONS];
                if (selectedCategory !== 'all') {
                    filtered = filtered.filter(q => q.category === selectedCategory);
                }
                filtered = filtered.sort(() => 0.5 - Math.random());
                setQuestions(filtered);
                setCurrentQuestionIndex(0);
                setAnswers({});
                setIsAnswered(false);
            }, [selectedCategory]);

            useEffect(() => {
                setFavorites(DB.getFavorites());
            }, []);

            const toggleFavorite = (qId) => {
                const newFavs = DB.toggleFavorite(qId);
                setFavorites(new Set(newFavs));
            };

            const handleAnswer = (option) => {
                if (isAnswered) return; 
                const currentQ = questions[currentQuestionIndex];
                const isCorrect = option === currentQ.answer;
                setAnswers(prev => ({ ...prev, [currentQ.id]: option }));
                setIsAnswered(true);
                if (isCorrect) {
                    // Simple beep or use generated sound if AudioContext allows
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 2500);
                }
            };

            const handleSubmit = () => {
                if (isSubmitting) return; 
                setIsSubmitting(true);
                
                let score = 0;
                const details = questions.map(q => {
                    const isCorrect = answers[q.id] === q.answer;
                    if (isCorrect) score += 1;
                    return {
                        id: q.id,
                        question: q.question,
                        userAnswer: answers[q.id],
                        correctAnswer: q.answer,
                        isCorrect,
                        options: q.options,
                        category: q.category
                    };
                });

                // LocalStorage save
                DB.addHistory({
                    date: new Date().toLocaleString(),
                    score: Math.round((score / questions.length) * 100),
                    total: questions.length,
                    category: selectedCategory === 'all' ? '綜合挑戰' : selectedCategory,
                    details: details
                });

                details.forEach(d => {
                    if (!d.isCorrect) DB.addMistake(d);
                    else DB.removeMistake(d.id);
                });

                onComplete({ score: Math.round((score / questions.length) * 100), details });
            };

            if (!selectedCategory) {
                const categories = [
                    { id: '形音義與題解', label: '形音義與題解', icon: <Icons.PenTool className="w-6 h-6 text-blue-500"/>, desc: '字音字形、題解與作者背景' },
                    { id: '史記體例表格', label: '史記體例表格', icon: <Icons.LayoutGrid className="w-6 h-6 text-purple-500"/>, desc: '本紀、世家、列傳等體例分類' },
                    { id: '成語典故', label: '成語典故', icon: <Icons.BookOpen className="w-6 h-6 text-emerald-500"/>, desc: '源自史記的著名成語與典故' },
                    { id: '課文詞語與語法', label: '課文詞語與語法', icon: <Icons.Layers className="w-6 h-6 text-orange-500"/>, desc: '課文中的重要實詞、虛詞與修辭' },
                    { id: '敬詞謙詞對照表', label: '敬詞謙詞對照表', icon: <Icons.User className="w-6 h-6 text-pink-500"/>, desc: '古代常見的敬語與謙稱用法' },
                    { id: 'all', label: '全範圍綜合挑戰', icon: <Icons.Zap className="w-6 h-6 text-yellow-500"/>, desc: '包含以上所有單元的綜合測驗', isAll: true },
                ];
                return (
                    <div className="h-full flex flex-col bg-stone-50">
                        <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center sticky top-0 z-10"><button onClick={onBack} className="flex items-center text-stone-600 hover:text-orange-600 mr-4"><Icons.ArrowLeft className="w-5 h-5 mr-1" /> 返回</button><h2 className="font-bold text-lg text-stone-800">選擇測驗單元</h2></div>
                        <div className="p-6 overflow-y-auto"><div className="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">{categories.map(cat => (<button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`text-left p-6 rounded-2xl shadow-sm border-2 transition hover:shadow-md flex items-start ${cat.isAll ? 'bg-gradient-to-br from-yellow-50 to-orange-50 border-yellow-200 hover:border-yellow-400' : 'bg-white border-stone-100 hover:border-orange-200'}`}><div className={`p-3 rounded-full mr-4 ${cat.isAll ? 'bg-white shadow-sm' : 'bg-stone-50'}`}>{cat.icon}</div><div><h3 className={`font-bold text-lg mb-1 ${cat.isAll ? 'text-yellow-800' : 'text-stone-800'}`}>{cat.label}</h3><p className="text-sm text-stone-500">{cat.desc}</p></div></button>))}</div></div>
                    </div>
                );
            }

            if (questions.length === 0) return <LoadingScreen />;
            const currentQ = questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            
            return (
                <div className="h-full flex flex-col bg-stone-50 relative">
                    {showConfetti && <Confetti />}
                    <div className="bg-white shadow-sm px-4 py-3 flex items-center justify-between z-10">
                        <div className="flex items-center"><button onClick={onBack} className="flex items-center text-stone-500 hover:text-orange-600 mr-4 px-3 py-1 rounded-full hover:bg-stone-50 transition border border-transparent hover:border-stone-200"><Icons.Home className="w-4 h-4 mr-1" /> <span className="text-sm font-medium">首頁</span></button><div className="flex items-center text-stone-500 border-l pl-4"><span className="font-mono text-lg font-bold text-orange-600 mr-2">{currentQuestionIndex + 1}</span><span className="text-sm">/ {questions.length}</span></div></div>
                        <div className="flex-1 mx-4 h-2 bg-stone-200 rounded-full overflow-hidden max-w-xs md:max-w-md hidden md:block"><div className="h-full bg-orange-500 transition-all duration-300" style={{ width: `${progress}%` }}></div></div>
                        <button onClick={() => toggleFavorite(currentQ.id)} className={`p-2 rounded-full hover:bg-stone-100 transition`}><Icons.Heart className={`w-6 h-6 transition-colors duration-300 ${favorites.has(currentQ.id) ? 'fill-rose-500 text-rose-500' : 'text-stone-400'}`} /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col items-center">
                        <div className="w-full max-w-2xl flex-1">
                            <div className="bg-white rounded-2xl shadow-lg p-6 md:p-10 mb-6 relative">
                                <span className="inline-block px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded-full mb-4">{currentQ.category}</span>
                                <h3 className="text-xl md:text-2xl font-bold text-stone-800 mb-8 leading-relaxed">{currentQ.question}</h3>
                                <div className="space-y-3">{currentQ.options.map((opt, i) => {
                                    let statusClass = "border-stone-100 hover:border-stone-300 text-stone-700";
                                    if (isAnswered) { if (opt === currentQ.answer) { statusClass = "border-emerald-500 bg-emerald-50 text-emerald-900 font-bold"; } else if (opt === answers[currentQ.id]) { statusClass = "border-red-500 bg-red-50 text-red-900"; } else { statusClass = "border-stone-100 opacity-50"; } }
                                    return (<button key={i} onClick={() => handleAnswer(opt)} disabled={isAnswered} className={`w-full text-left p-5 rounded-xl border-2 transition relative text-lg font-medium ${statusClass}`}><span className="inline-block w-6 font-bold text-stone-400 mr-2">{String.fromCharCode(65 + i)}.</span>{opt}{isAnswered && opt === currentQ.answer && <Icons.CheckCircle className="w-5 h-5 text-emerald-600 absolute right-4 top-1/2 -translate-y-1/2" />}{isAnswered && opt === answers[currentQ.id] && opt !== currentQ.answer && <Icons.XCircle className="w-5 h-5 text-red-600 absolute right-4 top-1/2 -translate-y-1/2" />}</button>);
                                })}</div>
                            </div>
                            {isAnswered && (<div className={`rounded-xl p-6 mb-6 animate-fade-in ${answers[currentQ.id] === currentQ.answer ? 'bg-emerald-100 text-emerald-900' : 'bg-red-50 text-red-900'}`}><div className="flex items-center mb-2 font-bold text-lg">{answers[currentQ.id] === currentQ.answer ? <><Icons.CheckCircle className="w-6 h-6 mr-2" /> 答對了！</> : <><Icons.XCircle className="w-6 h-6 mr-2" /> 答錯了！</>}</div><div className="mt-4 text-xl"><span className="font-bold">正確答案：</span> {currentQ.answer}<div className="mt-3 text-stone-700 text-lg leading-relaxed">此題出自 <span className="font-semibold">{currentQ.category}</span> 章節。</div></div></div>)}
                        </div>
                    </div>
                    <div className="bg-white p-4 border-t flex justify-between items-center z-10 sticky bottom-0">
                        <div className="w-24"></div> 
                        {isAnswered ? (currentQuestionIndex < questions.length - 1 ? (<button onClick={() => { setIsAnswered(false); setShowConfetti(false); setCurrentQuestionIndex(c => c + 1); }} className="px-8 py-3 bg-stone-800 text-white rounded-full hover:bg-stone-700 transition font-bold shadow-lg flex items-center animate-bounce-subtle">下一題 <Icons.ChevronRight className="w-5 h-5 ml-1" /></button>) : (<button onClick={handleSubmit} disabled={isSubmitting} className="px-8 py-3 bg-orange-600 text-white rounded-full hover:bg-orange-700 transition font-bold shadow-lg shadow-orange-200 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">{isSubmitting ? <><Icons.Loader2 className="w-5 h-5 mr-2 animate-spin" /> 處理中...</> : <>查看總成績 <Icons.CheckCircle className="w-5 h-5 ml-2" /></>}</button>)) : (<div className="text-stone-400 text-sm italic">請選擇一個答案以繼續</div>)}<div className="w-24"></div>
                    </div>
                </div>
            );
        };

        const ResultReview = ({ result, onExit }) => {
            return (
                <div className="h-full bg-stone-50 overflow-y-auto">
                    <div className="max-w-3xl mx-auto p-6">
                        <div className="bg-white rounded-3xl shadow-lg p-8 mb-8 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-500 to-amber-500"></div>
                            <h2 className="text-3xl font-bold text-stone-800 mb-2">測驗結果</h2>
                            <div className="text-6xl font-black text-orange-600 my-4">{result.score}<span className="text-2xl text-stone-400 font-normal">分</span></div>
                            <div className="flex justify-center gap-4 text-sm text-stone-500">
                                <span>總題數: {result.details.length}</span>
                                <span className="text-green-600">答對: {result.details.filter(d => d.isCorrect).length}</span>
                                <span className="text-red-500">答錯: {result.details.filter(d => !d.isCorrect).length}</span>
                            </div>
                            <button onClick={onExit} className="mt-8 px-8 py-2 border border-stone-300 rounded-full hover:bg-stone-50 transition">返回首頁</button>
                        </div>
                        <h3 className="text-xl font-bold text-stone-800 mb-4 px-2">試題解析</h3>
                        <div className="space-y-4">
                            {result.details.map((item, i) => (
                                <div key={i} className={`bg-white rounded-xl shadow-sm p-6 border-l-4 ${item.isCorrect ? 'border-emerald-500' : 'border-red-500'}`}>
                                    <div className="flex items-start justify-between mb-3">
                                        <h4 className="font-bold text-lg text-stone-800 flex-1">{i + 1}. {item.question}</h4>
                                        {item.isCorrect ? <Icons.CheckCircle className="w-6 h-6 text-emerald-500 flex-shrink-0" /> : <Icons.XCircle className="w-6 h-6 text-red-500 flex-shrink-0" />}
                                    </div>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex items-center"><span className="w-20 text-stone-500">您的答案：</span><span className={`font-bold ${item.isCorrect ? 'text-emerald-700' : 'text-red-600'}`}>{item.userAnswer || '(未作答)'}</span></div>
                                        {!item.isCorrect && <div className="flex items-center"><span className="w-20 text-stone-500">正確答案：</span><span className="font-bold text-emerald-700">{item.correctAnswer}</span></div>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ title, type, user, onBack }) => {
            const [items, setItems] = useState([]);
            const [expandedId, setExpandedId] = useState(null);

            useEffect(() => {
                let data = [];
                if (type === 'history') data = DB.getHistory();
                else if (type === 'mistakes') data = DB.getMistakes();
                else if (type === 'favorites') {
                    const favs = DB.getFavorites();
                    // Need to filter from ALL_QUESTIONS
                    const allQs = ALL_QUESTIONS;
                    data = allQs.filter(q => favs.has(q.id));
                }
                setItems(data);
            }, [type]);

            return (
                <div className="h-full bg-stone-50 flex flex-col">
                    <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center sticky top-0 z-10">
                        <button onClick={onBack} className="flex items-center text-stone-600 hover:text-orange-600 mr-4"><Icons.ArrowLeft className="w-5 h-5 mr-1" /> 返回</button>
                        <h2 className="font-bold text-lg">{title}</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-6">
                        <div className="max-w-3xl mx-auto space-y-4">
                            {items.length === 0 && <div className="text-center py-20 text-stone-400"><p>目前沒有紀錄</p></div>}
                            
                            {type === 'history' && items.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition">
                                    <div className="flex justify-between items-center cursor-pointer" onClick={() => setExpandedId(expandedId === item.id ? null : item.id)}>
                                        <div>
                                            <div className="text-stone-500 text-xs mb-1">{item.date}</div>
                                            <div className="font-bold text-stone-800 flex items-center">
                                                <span className="mr-2 text-sm bg-stone-100 px-2 py-0.5 rounded text-stone-600">{item.category}</span>
                                                測驗得分：<span className={`text-lg ml-1 ${item.score >= 80 ? 'text-emerald-600' : 'text-orange-600'}`}>{item.score}</span> 分
                                            </div>
                                        </div>
                                        {expandedId === item.id ? <Icons.ChevronUp className="w-5 h-5 text-stone-400" /> : <Icons.ChevronDown className="w-5 h-5 text-stone-400" />}
                                    </div>
                                    {expandedId === item.id && (
                                        <div className="mt-4 pt-4 border-t border-stone-100 space-y-4">
                                            {item.details.map((d, i) => (
                                                <div key={i} className="bg-stone-50 p-4 rounded-lg border border-stone-200">
                                                    <div className="flex items-start mb-3"><span className="font-mono font-bold text-orange-600 mr-2 mt-0.5">{i+1}.</span><h4 className="font-bold text-stone-800 text-lg leading-snug flex-1">{d.question}</h4>{d.isCorrect ? <Icons.CheckCircle className="w-5 h-5 text-emerald-500 flex-shrink-0 ml-2" /> : <Icons.XCircle className="w-5 h-5 text-red-500 flex-shrink-0 ml-2" />}</div>
                                                    <div className="space-y-1 mb-3 pl-6">
                                                        {d.options && d.options.map((opt, idx) => {
                                                            let optionStyle = "text-stone-600";
                                                            let icon = null;
                                                            if (opt === d.correctAnswer) { optionStyle = "bg-emerald-100 text-emerald-800 font-bold border-emerald-200"; icon = <Icons.CheckCircle className="w-4 h-4 ml-2 inline" />; } 
                                                            else if (opt === d.userAnswer && !d.isCorrect) { optionStyle = "bg-red-50 text-red-800 line-through border-red-100"; icon = <Icons.XCircle className="w-4 h-4 ml-2 inline" />; }
                                                            return (<div key={idx} className={`px-3 py-2 rounded text-sm border border-transparent ${optionStyle} flex items-center`}><span className="font-mono w-5 opacity-50 mr-1">{String.fromCharCode(65 + idx)}.</span><span className="flex-1">{opt}</span>{icon}</div>);
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}

                            {(type === 'mistakes' || type === 'favorites') && items.map((item) => (
                                <div key={item.id} className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-400">
                                    <div className="flex justify-between mb-3">
                                        <span className="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded">{item.category}</span>
                                        {type === 'mistakes' ? <span className="text-xs text-red-500 font-bold">答錯</span> : <Icons.Heart className="w-5 h-5 fill-rose-500 text-rose-500" />}
                                    </div>
                                    <h3 className="font-bold text-lg text-stone-800 mb-3">{item.question}</h3>
                                    <div className="bg-emerald-50 p-3 rounded text-sm text-emerald-800"><span className="font-bold">正確答案：</span> {item.answer}</div>
                                    <div className="mt-4 flex justify-end">
                                        {type === 'mistakes' && <button onClick={() => { DB.removeMistake(item.id); setItems(prev => prev.filter(p => p.id !== item.id)); }} className="text-sm text-stone-400 hover:text-red-500 flex items-center"><Icons.CheckCircle className="w-4 h-4 mr-1"/> 我學會了（移除）</button>}
                                        {type === 'favorites' && <button onClick={() => { DB.toggleFavorite(item.id); setItems(prev => prev.filter(p => p.id !== item.id)); }} className="text-sm text-stone-400 hover:text-red-500 flex items-center"><Icons.Heart className="w-4 h-4 mr-1"/> 取消收藏</button>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('auth'); 
            const [quizResult, setQuizResult] = useState(null);

            useEffect(() => {
                const existingUser = DB.getUser();
                if (existingUser) {
                    setUser(existingUser);
                    setView('dashboard');
                }
            }, []);

            if (view === 'auth') return <AuthScreen onLogin={(u) => { setUser(u); setView('dashboard'); }} />;
            if (view === 'dashboard') return <Dashboard user={user} onNavigate={setView} onLogout={() => { DB.clearUser(); setUser(null); setView('auth'); }} />;
            if (view === 'learn') return <LearningModule onBack={() => setView('dashboard')} />;
            if (view === 'quiz_setup') return <QuizModule user={user} onBack={() => setView('dashboard')} onComplete={(res) => { setQuizResult(res); setView('quiz_result'); }} />;
            if (view === 'quiz_result') return <ResultReview result={quizResult} onExit={() => setView('dashboard')} />;
            if (view === 'history') return <ListView title="測驗歷史紀錄" type="history" user={user} onBack={() => setView('dashboard')} />;
            if (view === 'mistakes') return <ListView title="錯題本 (尚未掌握)" type="mistakes" user={user} onBack={() => setView('dashboard')} />;
            if (view === 'favorites') return <ListView title="我的題目收藏" type="favorites" user={user} onBack={() => setView('dashboard')} />;

            return <div className="p-4 text-center">未知頁面</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>