<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>張釋之執法 - 互動學習 App (完整版)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        .animate-bounce-subtle {
            animation: bounceSubtle 2s infinite;
        }

        .animate-confetti {
            position: absolute;
            width: 10px;
            height: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounceSubtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            BookOpen, PenTool, History, Heart, AlertCircle, CheckCircle, XCircle, 
            ChevronRight, LogOut, User, ArrowLeft, Zap, Volume2, Home, LayoutGrid, 
            Layers, ChevronDown, ChevronUp, Loader2, Sparkles, Image as ImageIcon, Download, ImageOff,
            ListChecks, Trophy
        } from 'lucide-react';

        // --- LocalStorage Database Helper ---
        // 模擬資料庫操作，將資料存於 LocalStorage
        const STORAGE_KEYS = {
            USER: 'learning_app_user',
            HISTORY: 'learning_app_history',
            MISTAKES: 'learning_app_mistakes',
            FAVORITES: 'learning_app_favorites'
        };

        const LocalDB = {
            getUser: () => {
                const data = localStorage.getItem(STORAGE_KEYS.USER);
                return data ? JSON.parse(data) : null;
            },
            saveUser: (name) => {
                const user = { uid: 'local-user', displayName: name, lastLogin: new Date().toISOString() };
                localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(user));
                return user;
            },
            clearUser: () => {
                localStorage.removeItem(STORAGE_KEYS.USER);
            },
            
            // 歷史紀錄
            getHistory: () => {
                const data = localStorage.getItem(STORAGE_KEYS.HISTORY);
                return data ? JSON.parse(data) : [];
            },
            addHistory: (record) => {
                const list = LocalDB.getHistory();
                const newRecord = { ...record, id: Date.now().toString(), date: new Date().toISOString() };
                list.unshift(newRecord); 
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(list));
                return newRecord;
            },

            // 錯題本
            getMistakes: () => {
                const data = localStorage.getItem(STORAGE_KEYS.MISTAKES);
                return data ? JSON.parse(data) : [];
            },
            addMistake: (mistake) => {
                const list = LocalDB.getMistakes();
                const exists = list.some(item => item.id === mistake.id);
                if (!exists) {
                    const newMistake = { ...mistake, timestamp: new Date().toISOString() };
                    list.unshift(newMistake);
                    localStorage.setItem(STORAGE_KEYS.MISTAKES, JSON.stringify(list));
                }
            },
            removeMistake: (id) => {
                const list = LocalDB.getMistakes().filter(item => item.id.toString() !== id.toString());
                localStorage.setItem(STORAGE_KEYS.MISTAKES, JSON.stringify(list));
            },

            // 收藏夾
            getFavorites: () => {
                const data = localStorage.getItem(STORAGE_KEYS.FAVORITES);
                return data ? new Set(JSON.parse(data)) : new Set();
            },
            toggleFavorite: (id) => {
                const favs = LocalDB.getFavorites();
                const idStr = id.toString();
                if (favs.has(idStr)) {
                    favs.delete(idStr);
                } else {
                    favs.add(idStr);
                }
                localStorage.setItem(STORAGE_KEYS.FAVORITES, JSON.stringify(Array.from(favs)));
                return favs;
            },
            removeFavorite: (id) => {
                const favs = LocalDB.getFavorites();
                favs.delete(id.toString());
                localStorage.setItem(STORAGE_KEYS.FAVORITES, JSON.stringify(Array.from(favs)));
            }
        };
        
        // --- Global Data Definitions (根據 PDF 內容完整更新) ---
        const STUDY_CONTENT = {
            intro: {
                title: "前哨站、題解、作者的補充注釋",
                items: [
                    { term: "先河", definition: "借指開創於先的人，或指事物的本源。" },
                    { term: "直言抗辯", definition: "以正直的言論加以辯駁。" },
                    { term: "風骨", definition: "指人的品格、性格。" },
                    { term: "太史令", definition: "古官名，為史官之長，漢武帝設置，負責記載朝廷大事兼掌天文曆法。" },
                    { term: "宮刑", definition: "男子去勢的刑罰，亦稱為「腐刑」，約始於商周時。" },
                    { term: "報任少卿書", definition: "司馬遷所著：「行莫醜於辱先，而莫大於宮刑。」（詬，音ㄍㄡˋ，恥辱。）" }
                ],
                author: {
                    title: "作者補充：司馬遷",
                    stages: [
                        "居家讀書期 (幼年~20歲)",
                        "壯遊南北期 (20歲~36歲)",
                        "繼志寫史期 (37~47歲)：38歲當太史令。42歲著手《史記》的著述。",
                        "忍辱著書期 (47~56歲)：47歲為李陵辯護而入獄，48歲為免死刑而接受宮刑。50歲出獄。漢武帝知道司馬遷是無辜的，升他為中書令。",
                        "晚年 (57~60歲)"
                    ],
                    motivation: "司馬遷出生於史官世家，父親司馬談是一位學識淵博的學者，在武帝年間擔任太史令，曾有宏願想編修一部重現春秋精神，論載明君賢臣死士的史書。司馬遷繼承父志，並欲「究天人之際，通古今之變，成一家之言」。從歷史人物客觀活動分析成敗得失，從歷史發展尋找歷代王朝興衰原因，更進一步透過史書表達他的社會政治理想。",
                    extra: "報任少卿書：司馬遷53歲時寫給好友任安的一篇自傳式長信，說明自己歷經腐刑的奇恥大辱後，「隱忍苟活」的原因，把自己的遭遇、心情及堅持完成史記的決心，詳盡地告訴好友。"
                }
            },
            shiji: {
                title: "史記內容簡介",
                description: "《史記》是中國史上首部紀傳體通史，共五十二萬六千餘字，有本紀十二卷、表十卷、書八卷、世家三十卷、列傳七十卷。",
                table: [
                    { 
                        category: "本紀", 
                        count: "十二卷", 
                        content: "記敘歷代帝王事蹟，是全書敘述的提綱。按時間記載帝王的世系和國家大事，以事繫年，屬於全國的編年大事紀。前五卷分別記述傳說中的五帝，以及夏、商、周和秦國前期歷史；後七卷記載秦始皇和漢高祖劉邦至漢武帝時期的逐年大事。", 
                        note: "項羽、呂后並非帝王，但司馬遷認為他們具有影響世局發展的力量，因此破例列入本紀，題為項羽本紀、呂太后本紀。",
                        image: "images/shiji_0.jpg"
                    },
                    { 
                        category: "表", 
                        count: "十卷", 
                        content: "以時間為中心，用表格方式整理重大歷史事件。使歷史發展的脈絡更為明晰。", 
                        note: "「表」的形式源於周譜，是用表格譜列歷史大事件，和某些列傳長篇幅記載的人物活動相較，這種寫法使歷史發展的脈絡更為明晰。",
                        image: "images/shiji_1.jpg"
                    },
                    { 
                        category: "書", 
                        count: "八卷", 
                        content: "記國家體制。對天文、曆法、經濟、文化、水利，以及典章制度作專門論述。", 
                        note: "—",
                        image: "images/shiji_2.jpg"
                    },
                    { 
                        category: "世家", 
                        count: "三十卷", 
                        content: "記述貴族王侯及其子孫的歷史事蹟。多記述春秋、戰國時期各諸侯國興衰存亡的歷史。有些事件雖不涉及全國範圍，但對某一封國或全國社稷生活的某一方面有較大影響的，皆收入書中。", 
                        note: "破例收錄：1.孔子（因學問傳世，推崇其為至聖）。2.陳涉（為中國首位起義欲推翻朝廷的平民百姓，且曾自立為王）。3.外戚（后妃得寵使外戚成為影響朝廷的重要勢力）。",
                        image: "images/shiji_3.jpg"
                    },
                    { 
                        category: "列傳", 
                        count: "七十卷", 
                        content: "列敘大臣至於平民各類人物的歷史表現。「列傳」為司馬遷首創的史書體例，專記歷史上的重要人物。包含：專傳（單記一人，如伍子胥列傳）、合傳（記述兩人或數人以上，如廉頗藺相如列傳）、類傳（收錄若干同類人物，如刺客列傳）。", 
                        note: "1. 少數列傳記外國史和少數民族史，例如：匈奴列傳等。 2. 末篇太史公自序為自傳，司馬遷在該篇中先敘自己的家世和事蹟，並說明編著本書的經過和旨意。",
                        image: "images/shiji_4.jpg"
                    }
                ]
            },
            idioms: {
                title: "出自史記的名句",
                items: [
                    { 
                        name: "燕雀安知鴻鵠之志", 
                        mean: "小小的燕子和麻雀哪裡知道大鳥（大雁或天鵝）欲展翅翱翔的宏願呢？比喻一般人無法明白雄才大略者的遠大志向。", 
                        source: "《史記．陳涉世家》：「陳涉太息曰：『嗟乎，燕雀安知鴻鵠之志哉！』」",
                        image: "images/idioms_0.jpg"
                    },
                    { 
                        name: "桃李不言，下自成蹊", 
                        mean: "比喻只要為人真誠，自能感動別人，為人所敬仰；或比喻應注重實際，不尚虛名。（蹊，小路）。", 
                        source: "《史記．李將軍列傳》：「諺曰：『桃李不言，下自成蹊。』此言雖小，可以諭大也。」",
                        image: "images/idioms_1.jpg" 
                    },
                    { 
                        name: "不鳴則已，一鳴驚人", 
                        mean: "鳥三年不飛不鳴，但一飛即可沖天，一鳴即能驚人。比喻人平時沒有特殊表現、默默無聞，一旦施展才華，即能做出非凡的成果。", 
                        source: "《史記．淳于髡傳》：「此鳥不飛則已，一飛沖天；不鳴則已，一鳴驚人。」",
                        image: "images/idioms_2.jpg"
                    },
                    { 
                        name: "運籌帷幄之中，決勝千里之外", 
                        mean: "將領在軍營中謀畫軍事戰略，就可以使在千里之外的戰場上的士兵們，戰勝敵人。說明某人善於謀略及指揮。（帷幄，軍營中的帳幕）。", 
                        source: "《史記．高祖本紀》：「夫運籌策帷帳之中，決勝於千里之外，吾不如子房（張良）。」",
                        image: "images/idioms_3.jpg"
                    },
                    { 
                        name: "無顏見江東父老", 
                        mean: "指心懷羞愧，沒臉見自己人。", 
                        source: "《史記．項羽本紀》：楚漢相爭，項羽被漢軍困在垓下，四面楚歌。後項王退到烏江西岸。烏江亭長勸項羽渡江回到江東，據地為王。項羽笑曰：「縱江東父兄憐而王我，我何面目見之？」乃自刎而死。",
                        image: "images/idioms_4.jpg"
                    }
                ]
            },
            grammar: {
                title: "課文詞語的補充注釋與辨析",
                items: [
                    { text: "1. 釋之「為」廷尉", mean: "當、擔任", image: "images/grammar_0.jpg" },
                    { text: "2. 於是「使」騎捕", mean: "派遣" },
                    { text: "3. 於是使「騎」捕", mean: "騎兵", image: "images/grammar_2.jpg" },
                    { text: "4. 「匿」橋下", mean: "隱藏", image: "images/grammar_3.jpg" },
                    { text: "5. 久「之」，以為行已過", mean: "助詞，無義" },
                    { text: "6. 「即」出，見乘輿車騎即走耳", mean: "便、就" },
                    { text: "7. 即出，見乘輿車騎「即」走耳", mean: "便、就" },
                    { text: "8. 即出，見乘輿車騎即走「耳」", mean: "矣、了" },
                    { text: "9. 一人犯蹕，「當」罰金", mean: "判處", image: "images/grammar_8.jpg" },
                    { text: "10. 此人「親」驚吾馬", mean: "親自" },
                    { text: "11. 而廷尉乃「當」之罰金", mean: "判處" },
                    { text: "12. 法「者」，天子所與天下公共也", mean: "助詞，用於句中，表示停頓" },
                    { text: "13. 今法如此「而」更重之", mean: "卻。亦可作「假如」" },
                    { text: "14. 今法如此而更「重」之", mean: "加重" },
                    { text: "15. 今法如此而更重「之」", mean: "指罪" },
                    { text: "16. 「是」法不信於民也", mean: "此、這" },
                    { text: "17. 是法不信「於」民也", mean: "被" },
                    { text: "18. 上「使」立誅之則已", mean: "假使。另有一說作「派人」" },
                    { text: "19. 天下「之」平也", mean: "的" },
                    { text: "20. 一傾而「天下」用法皆為輕重", mean: "指天下執行法律者" },
                    { text: "21. 用法皆為輕重", mean: "此處原句為：「用法皆為之輕重」，省略的「之」字，指執法偏斜不正" },
                    { text: "22. 唯陛下察「之」", mean: "指此事" },
                    { text: "23. 「良」久，上曰：「廷尉當是也。」", mean: "很、甚、極" },
                    { text: "24. 廷尉「當」是也", mean: "判決" },
                    { text: "25. 廷尉當「是」也", mean: "正確的" },
                    { text: "補充：涇渭分明", mean: "涇水、渭水各有清濁，二水會合，仍分得很清楚。比喻是非好壞區別得非常清楚。反義：涇渭不分。", image: "images/grammar_21.jpg" },
                    { text: "補充：無隙可乘", mean: "沒有可以利用的機會。" },
                    { text: "補充：「令」他馬", mean: "近義：如、若、使、倘。" },
                    { text: "補充：立誅之辨析", mean: "表殺死義時，「殺」是通稱。「弒」多用於下殺上。「戮」多用於上殺下。「誅」表殺有罪之人。" },
                    { text: "補充：陛下", mean: "近義：皇上、聖上。反義：百姓、布衣、黎民、黔首。（黔：黑色。源於古人以黑色頭巾包覆頭部的習俗，意指平民百姓。）", image: "images/grammar_23.jpg" }
                ]
            },
            honorifics: {
                title: "敬詞謙詞對照表",
                intro: "中華民族一向有禮儀之邦的稱號。古時，臣子對皇帝敬稱「陛下」，是從秦始皇開始的。「陛」是正殿的最高階。臣下要奏事或上書時，請臺階之下的近臣轉達，故用「陛下」來敬稱皇帝，而臣子則謙稱自己為「下臣」。",
                respect: [
                    { key: "令", words: "令尊(稱對方的父親)、令堂(稱對方的母親)、令郎(稱對方的兒子)、令媛(稱對方的女兒)" },
                    { key: "尊", words: "尊夫人(稱對方的妻子)、尊姓大名(當面問人姓名時的敬詞)" },
                    { key: "貴", words: "貴庚(問對方的年齡)、貴姓(問對方的姓氏)、貴校/貴公司(稱對方的學校/公司)、貴公館(稱對方的住處)" },
                    { key: "賢", words: "賢喬梓(稱對方父子)、賢昆仲/賢昆玉(稱對方兄弟)、賢伉儷(稱對方夫婦)" },
                    { key: "高", words: "高見(稱對方的見解)、高就(多用於詢問他人在何處任職)" }
                ],
                humble: [
                    { key: "家", words: "家父/家嚴(稱自己的父親)、家母/家慈(稱自己的母親)、家兄(稱自己的哥哥)、家姊(稱自己的姊姊) —— 稱自己的長輩和年長的平輩" },
                    { key: "舍", words: "舍弟(稱自己的弟弟)、舍姪(稱自己的姪子) —— 稱年紀小於自己的平輩或晚輩" },
                    { key: "敝", words: "敝人(稱自己)、敝校/敝公司(稱自己的學校/公司)、敝業師(稱自己的老師)" },
                    { key: "拙", words: "拙見(稱自己的見解)、拙著(稱自己的作品)、拙荊(稱自己的妻子)" },
                    { key: "小", words: "小犬(稱自己的兒子)、小女(稱自己的女兒)、小店(稱自己的店)" },
                    { key: "薄", words: "薄禮(稱自己送的禮物：些許薄禮，敬請笑納)、薄面(稱自己的情面：看在我的薄面上)" }
                ]
            }
        };

        const generateQuestions = () => {
            const q = [];
            let id = 1;
            // 1. 形音義與題解
            q.push({ id: id++, category: "形音義與題解", question: "「先河」一詞的意思是？", options: ["河流的名字", "開創於先的人或事物本源", "已故的親人", "先進的河流技術"], answer: "開創於先的人或事物本源" });
            q.push({ id: id++, category: "形音義與題解", question: "「直言抗辯」的意思是？", options: ["大聲爭吵", "婉轉地拒絕", "以正直的言論加以辯駁", "直接放棄辯解"], answer: "以正直的言論加以辯駁" });
            q.push({ id: id++, category: "形音義與題解", question: "「風骨」是指人的什麼？", options: ["身體骨骼", "品格、性格", "穿著風格", "書法筆勁"], answer: "品格、性格" });
            q.push({ id: id++, category: "形音義與題解", question: "「太史令」的主要職責不包含下列何者？", options: ["記載朝廷大事", "掌天文", "掌曆法", "管理刑獄"], answer: "管理刑獄" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷受到的「宮刑」又稱為？", options: ["大辟", "腐刑", "墨刑", "劓刑"], answer: "腐刑" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷在哪篇著作中提到「行莫醜於辱先，而莫大於宮刑」？", options: ["史記自序", "報任少卿書", "項羽本紀", "悲士不遇賦"], answer: "報任少卿書" });
            q.push({ id: id++, category: "形音義與題解", question: "關於司馬遷的生平，下列何者正確？", options: ["出生於武將世家", "父親司馬談曾任宰相", "因這李陵辯護而入獄", "一生平步青雲未受挫折"], answer: "因這李陵辯護而入獄" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷著述《史記》的動機，可以用哪句話概括？", options: ["運籌帷幄之中", "究天人之際，通古今之變，成一家之言", "不鳴則已，一鳴驚人", "燕雀安知鴻鵠之志"], answer: "究天人之際，通古今之變，成一家之言" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷幾歲開始著手《史記》的著述？", options: ["20歲", "38歲", "42歲", "50歲"], answer: "42歲" });
            q.push({ id: id++, category: "形音義與題解", question: "「詬」字的讀音與意思為何？", options: ["ㄍㄡˋ，恥辱", "ㄏㄡˋ，後悔", "ㄍㄡˇ，苟且", "ㄏㄡˊ，諸侯"], answer: "ㄍㄡˋ，恥辱" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷的父親名為？", options: ["司馬談", "司馬懿", "司馬光", "司馬相如"], answer: "司馬談" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷出獄後，漢武帝升他為何種官職？", options: ["太史令", "中書令", "廷尉", "丞相"], answer: "中書令" });
            q.push({ id: id++, category: "形音義與題解", question: "下列關於司馬遷「壯遊南北期」的敘述何者正確？", options: ["發生在47~56歲", "主要為了逃避刑罰", "發生在20~36歲", "完全沒有發生過"], answer: "發生在20~36歲" });
            q.push({ id: id++, category: "形音義與題解", question: "《報任少卿書》是司馬遷寫給誰的信？", options: ["李陵", "漢武帝", "任安", "父親"], answer: "任安" });
            q.push({ id: id++, category: "形音義與題解", question: "司馬遷受宮刑時約為幾歲？", options: ["38歲", "42歲", "48歲", "50歲"], answer: "48歲" });

            // 2. 史記體例表格
            q.push({ id: id++, category: "史記體例表格", question: "《史記》是中國史上首部什麼體例的史書？", options: ["編年體通史", "紀傳體通史", "國別史", "斷代史"], answer: "紀傳體通史" });
            q.push({ id: id++, category: "史記體例表格", question: "《史記》中記載歷代帝王事蹟，屬於全書提綱的是哪一類？", options: ["世家", "列傳", "本紀", "表"], answer: "本紀" });
            q.push({ id: id++, category: "史記體例表格", question: "哪位人物並非帝王，但因影響世局重大而被司馬遷破例列入「本紀」？", options: ["孔子", "陳涉", "項羽", "韓信"], answer: "項羽" });
            q.push({ id: id++, category: "史記體例表格", question: "記載諸侯王侯興衰歷史的是哪一類？", options: ["本紀", "世家", "列傳", "書"], answer: "世家" });
            q.push({ id: id++, category: "史記體例表格", question: "孔子被列入《史記》的哪一類？", options: ["本紀", "世家", "列傳", "表"], answer: "世家" });
            q.push({ id: id++, category: "史記體例表格", question: "中國首位起義的平民陳涉，被列入哪一類？", options: ["列傳", "本紀", "世家", "書"], answer: "世家" });
            q.push({ id: id++, category: "史記體例表格", question: "專門記載典章制度（如天文、曆法、水利）的是？", options: ["表", "書", "本紀", "列傳"], answer: "書" });
            q.push({ id: id++, category: "史記體例表格", question: "《史記》中的「表」主要作用是？", options: ["記載帝王家世", "用表格整理大事，使歷史脈絡明晰", "論述天文地理", "記敘平民事蹟"], answer: "用表格整理大事，使歷史脈絡明晰" });
            q.push({ id: id++, category: "史記體例表格", question: "「呂后」被司馬遷列入哪一類體例？", options: ["列傳", "世家", "本紀", "書"], answer: "本紀" });
            q.push({ id: id++, category: "史記體例表格", question: "下列關於「列傳」的敘述，何者錯誤？", options: ["是司馬遷首創的體例", "專記帝王的逐年大事", "包含專傳、合傳、類傳", "記載社會各階層代表人物"], answer: "專記帝王的逐年大事" });
            q.push({ id: id++, category: "史記體例表格", question: "《刺客列傳》屬於哪一種列傳寫法？", options: ["專傳", "合傳", "類傳", "自傳"], answer: "類傳" });
            q.push({ id: id++, category: "史記體例表格", question: "《史記》全書共有多少卷？", options: ["100卷", "130卷", "70卷", "12卷"], answer: "130卷" });
            q.push({ id: id++, category: "史記體例表格", question: "「本紀」共有幾卷？", options: ["12卷", "10卷", "30卷", "70卷"], answer: "12卷" });
            q.push({ id: id++, category: "史記體例表格", question: "「世家」共有幾卷？", options: ["12卷", "8卷", "30卷", "70卷"], answer: "30卷" });
            q.push({ id: id++, category: "史記體例表格", question: "「列傳」共有幾卷？", options: ["30卷", "70卷", "130卷", "10卷"], answer: "70卷" });
            q.push({ id: id++, category: "史記體例表格", question: "《史記》最後一篇為何？", options: ["孔子世家", "太史公自序", "貨殖列傳", "項羽本紀"], answer: "太史公自序" });
            q.push({ id: id++, category: "史記體例表格", question: "「外戚」因為后妃勢力影響朝廷，被破例列入哪一類？", options: ["本紀", "世家", "列傳", "表"], answer: "世家" });
            q.push({ id: id++, category: "史記體例表格", question: "記載「匈奴」歷史的是哪一類？", options: ["本紀", "書", "世家", "列傳"], answer: "列傳" });
            q.push({ id: id++, category: "史記體例表格", question: "下列何者屬於「書」的內容？", options: ["歷代帝王世系", "經濟、水利、禮樂", "諸侯興衰", "平民百姓事蹟"], answer: "經濟、水利、禮樂" });
            q.push({ id: id++, category: "史記體例表格", question: "《史記》中用來補足「本紀」紀年不足，展示歷史發展脈絡的是？", options: ["表", "書", "世家", "列傳"], answer: "表" });

            // 3. 成語典故
            q.push({ id: id++, category: "成語典故", question: "「燕雀安知鴻鵠之志」比喻什麼？", options: ["朋友間的誤會", "一般人無法明白雄才大略者的遠大志向", "鳥類的習性不同", "地位高低無法溝通"], answer: "一般人無法明白雄才大略者的遠大志向" });
            q.push({ id: id++, category: "成語典故", question: "「桃李不言，下自成蹊」出自《史記》哪一篇？", options: ["項羽本紀", "陳涉世家", "李將軍列傳", "孔子世家"], answer: "《史記．李將軍列傳》" });
            q.push({ id: id++, category: "成語典故", question: "「運籌帷幄之中，決勝千里之外」是用來稱讚誰？", options: ["韓信", "張良", "蕭何", "陳平"], answer: "張良" });
            q.push({ id: id++, category: "成語典故", question: "「無顏見江東父老」與哪位歷史人物有關？", options: ["劉邦", "項羽", "韓信", "張釋之"], answer: "項羽" });
            q.push({ id: id++, category: "成語典故", question: "「不鳴則已，一鳴驚人」最初是用來形容哪種動物？", options: ["龍", "鳳凰", "大鳥", "麒麟"], answer: "大鳥" });
            q.push({ id: id++, category: "成語典故", question: "「桃李不言，下自成蹊」中的「蹊」意思為何？", options: ["溪流", "小路", "果實", "樹蔭"], answer: "小路" });
            q.push({ id: id++, category: "成語典故", question: "「運籌帷幄」中的「帷幄」是指？", options: ["軍營中的帳幕", "古代的戰車", "皇帝的宮殿", "書房"], answer: "軍營中的帳幕" });
            q.push({ id: id++, category: "成語典故", question: "項羽說「縱江東父兄憐而王我，我何面目見之？」這句話衍生出哪個成語？", options: ["四面楚歌", "東山再起", "無顏見江東父老", "破釜沉舟"], answer: "無顏見江東父老" });
            q.push({ id: id++, category: "成語典故", question: "「燕雀安知鴻鵠之志」出自《史記》的哪一篇？", options: ["項羽本紀", "陳涉世家", "孔子世家", "留侯世家"], answer: "《史記．陳涉世家》" });
            q.push({ id: id++, category: "成語典故", question: "「不鳴則已，一鳴驚人」這句話出自《史記》哪一篇傳記？", options: ["滑稽列傳（淳于髡）", "刺客列傳", "游俠列傳", "酷吏列傳"], answer: "《史記．淳于髡傳》" });
            q.push({ id: id++, category: "成語典故", question: "「鴻鵠」在「燕雀安知鴻鵠之志」中借代為？", options: ["小人", "君子", "英雄豪傑", "普通百姓"], answer: "英雄豪傑" });
            q.push({ id: id++, category: "成語典故", question: "「桃李不言，下自成蹊」常用來比喻什麼？", options: ["為人真誠，自能感動別人", "果實甜美", "交通便利", "口才很好"], answer: "為人真誠，自能感動別人" });
            q.push({ id: id++, category: "成語典故", question: "「運籌帷幄」這句話是在哪一篇中劉邦稱讚張良的？", options: ["高祖本紀", "項羽本紀", "留侯世家", "淮陰侯列傳"], answer: "《史記．高祖本紀》" });
            q.push({ id: id++, category: "成語典故", question: "項羽被困在哪裡時，發出了「無顏見江東父老」的感嘆？", options: ["垓下", "烏江", "咸陽", "鴻門"], answer: "烏江" });
            q.push({ id: id++, category: "成語典故", question: "「燕雀」在成語中比喻什麼樣的人？", options: ["志向遠大的人", "見識短淺的一般人", "說話輕聲細語的人", "動作敏捷的人"], answer: "見識短淺的一般人" });

            // 4. 課文詞語與語法
            q.push({ id: id++, category: "課文詞語與語法", question: "「釋之為廷尉」的「為」字解釋為？", options: ["為了", "因為", "擔任", "被"], answer: "擔任" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「久之」的「之」字詞性與意義是？", options: ["代詞，指時間", "動詞，往", "助詞，無義", "介詞，的"], answer: "助詞，無義" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「廷尉當是也」的「當」字解釋為？", options: ["判決", "應當", "阻擋", "擔任"], answer: "判決" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「廷尉當是也」的「是」字解釋為？", options: ["此、這", "對、正確的", "贊同", "事情"], answer: "正確的" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「不信於民」的「於」字解釋為？", options: ["在", "給", "被", "從"], answer: "被" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「黔首」一詞意指？", options: ["皇帝", "貴族", "官員", "平民百姓"], answer: "平民百姓" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「良」久的「良」字解釋為？", options: ["良好", "很、甚", "善良", "稍微"], answer: "很、甚" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「乘輿」在課文中借代為？", options: ["馬車", "皇帝", "車夫", "馬匹"], answer: "皇帝" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「上使立誅之」中的「使」字解釋為？", options: ["派遣", "使用", "假使", "命令"], answer: "假使" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「一傾而天下用法皆為輕重」中的「傾」字意思為？", options: ["傾倒", "傾斜、偏差", "傾向", "完畢"], answer: "傾斜、偏差" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「是法不信於民也」中的「是」字解釋為？", options: ["正確", "是", "此、這", "凡是"], answer: "此、這" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「今法如此而更重之」中的「而」字解釋為？", options: ["而且", "卻/假如", "然後", "所以"], answer: "卻/假如" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「唯陛下察之」的「之」字是指？", options: ["張釋之", "犯人", "這件事（執法公正的重要性）", "廷尉"], answer: "這件事（執法公正的重要性）" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「涇渭分明」比喻什麼？", options: ["河水清澈", "是非好壞區別得非常清楚", "風景優美", "兩人感情分離"], answer: "是非好壞區別得非常清楚" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「無隙可乘」的意思是？", options: ["沒有車可以搭", "沒有空隙", "沒有可以利用的機會", "時間緊迫"], answer: "沒有可以利用的機會" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「下殺上」稱為什麼？", options: ["殺", "弒", "戮", "誅"], answer: "弒" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「上殺下」稱為什麼？", options: ["殺", "弒", "戮", "誅"], answer: "戮" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「殺有罪之人」稱為什麼？", options: ["殺", "弒", "戮", "誅"], answer: "誅" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「於是使騎捕」中的「騎」字詞性與意思為？", options: ["動詞，騎馬", "名詞，騎兵", "名詞，馬匹", "形容詞，快速的"], answer: "名詞，騎兵" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「匿橋下」的「匿」意思為？", options: ["隱藏", "溺水", "逃跑", "睡覺"], answer: "隱藏" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「見乘輿車騎即走耳」的「走」意思為？", options: ["走路", "跑", "離開", "發呆"], answer: "跑" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「見乘輿車騎即走耳」的「耳」意思為？", options: ["耳朵", "而已、罷了", "語助詞，無義", "聽見"], answer: "而已、罷了" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「此人親驚吾馬」的「親」意思為？", options: ["親人", "親自", "親近", "愛護"], answer: "親自" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「法者，天子所與天下公共也」的「者」字作用是？", options: ["指人", "指物", "語氣停頓", "疑問"], answer: "語氣停頓" });
            q.push({ id: id++, category: "課文詞語與語法", question: "「更重之」的「之」字指代什麼？", options: ["張釋之", "犯人", "罪/刑罰", "馬"], answer: "罪/刑罰" });

            // 5. 敬詞謙詞對照表
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "稱呼對方的父親，應使用？", options: ["家父", "令尊", "尊翁", "舍親"], answer: "令尊" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "向他人介紹自己的妻子，應使用？", options: ["尊夫人", "賢內助", "拙荊", "令正"], answer: "拙荊" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "稱呼對方的學校為「貴校」，稱呼自己的學校為？", options: ["小校", "拙校", "敝校", "賤校"], answer: "敝校" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「賢喬梓」是用來稱呼對方？", options: ["父子", "兄弟", "夫婦", "師生"], answer: "父子" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「賢昆仲」是用來稱呼對方？", options: ["父子", "兄弟", "夫婦", "朋友"], answer: "兄弟" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「小犬」是用來謙稱自己的？", options: ["寵物狗", "兒子", "孫子", "弟弟"], answer: "兒子" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "稱呼對方的母親，應使用？", options: ["家母", "令堂", "尊堂", "舍母"], answer: "令堂" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "稱呼對方的女兒，應使用？", options: ["小女", "令媛", "千金", "舍妹"], answer: "令媛" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "稱呼對方的夫婦，應使用？", options: ["賢喬梓", "賢昆仲", "賢伉儷", "尊夫人"], answer: "賢伉儷" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "謙稱自己的老師，應使用？", options: ["貴師", "敝業師", "尊師", "家師"], answer: "敝業師" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "稱呼對方的見解為「高見」，謙稱自己的見解為？", options: ["淺見", "拙見", "低見", "愚見"], answer: "拙見" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "詢問對方年齡的敬詞是？", options: ["幾歲", "貴庚", "高壽", "年紀"], answer: "貴庚" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "謙稱自己的弟弟為？", options: ["家弟", "舍弟", "令弟", "小弟"], answer: "舍弟" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "謙稱自己的店鋪為？", options: ["貴店", "敝店", "小店", "賤店"], answer: "小店" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "謙稱自己的父親為「家嚴」，謙稱母親為？", options: ["家慈", "家母", "舍母", "令堂"], answer: "家慈" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「尊夫人」是用來稱呼？", options: ["自己的妻子", "對方的妻子", "對方的母親", "自己的母親"], answer: "對方的妻子" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「舍姪」是用來稱呼？", options: ["對方的姪子", "自己的姪子", "自己的兒子", "鄰居的小孩"], answer: "自己的姪子" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「敝公司」是用來稱呼？", options: ["對方的公司", "自己的公司", "倒閉的公司", "關係企業"], answer: "自己的公司" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「薄禮」是用來謙稱？", options: ["便宜的禮物", "自己送的禮物", "對方送的禮物", "包裝很薄的禮物"], answer: "自己送的禮物" });
            q.push({ id: id++, category: "敬詞謙詞對照表", question: "「家兄」是用來稱呼？", options: ["對方的哥哥", "自己的哥哥", "長輩", "鄰居大哥"], answer: "自己的哥哥" });

            return q;
        };

        const ALL_QUESTIONS = generateQuestions(); 

        // --- Sound Helper ---
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'correct') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523.25, now);
                    osc.frequency.setValueAtTime(659.25, now + 0.1);
                    osc.frequency.setValueAtTime(783.99, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                    osc.start(now);
                    osc.stop(now + 0.5);
                } else {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            } catch (e) { console.error(e); }
        };

        // --- Confetti ---
        const Confetti = () => {
            const colors = ['#F97316', '#EF4444', '#F59E0B', '#EC4899', '#FB923C', '#FCD34D'];
            const pieces = Array.from({ length: 50 }).map((_, i) => ({
                id: i, left: Math.random() * 100 + '%', animationDelay: Math.random() * 0.5 + 's', backgroundColor: colors[Math.floor(Math.random() * colors.length)], rotation: Math.random() * 360 + 'deg'
            }));
            return (
                <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden">
                    {pieces.map((p) => (
                        <div key={p.id} className="absolute w-3 h-3 md:w-4 md:h-4 opacity-0 animate-confetti" style={{ left: p.left, top: '-20px', backgroundColor: p.backgroundColor, transform: `rotate(${p.rotation})`, animation: `fall 2.5s ease-out forwards ${p.animationDelay}` }} />
                    ))}
                    <style>{`@keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }`}</style>
                </div>
            );
        };

        // --- Main Components ---
        const LoadingScreen = () => (
            <div className="flex flex-col items-center justify-center h-screen bg-stone-50">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-4"></div>
                <p className="text-stone-600">載入中...</p>
            </div>
        );

        const AuthScreen = ({ onLogin }) => {
            const [name, setName] = useState('');
            const [savedName, setSavedName] = useState('');

            useEffect(() => {
                const user = LocalDB.getUser();
                if (user && user.displayName) {
                    setSavedName(user.displayName);
                }
            }, []);

            const handleLogin = (e, forcedName) => {
                if (e) e.preventDefault();
                const loginName = forcedName || name;
                if (!loginName.trim()) return;
                
                const user = LocalDB.saveUser(loginName);
                onLogin(user);
            };

            const handleQuickLogin = () => {
                const randomNum = Math.floor(Math.random() * 1000);
                const user = LocalDB.saveUser(`訪客 ${randomNum}`);
                onLogin(user);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-orange-100 to-amber-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-orange-500">
                        <div className="text-center mb-8">
                            <BookOpen className="w-16 h-16 text-orange-600 mx-auto mb-4" />
                            <h1 className="text-3xl font-bold text-stone-800">張釋之執法</h1>
                            <p className="text-stone-500 mt-2">互動式學習 App</p>
                        </div>
                        
                        {savedName && (
                            <div className="mb-6">
                                <button onClick={() => handleLogin(null, savedName)} className="w-full bg-gradient-to-r from-orange-500 to-amber-500 text-white py-4 rounded-xl font-bold hover:from-orange-600 hover:to-amber-600 transition shadow-lg shadow-orange-200 flex items-center justify-center group">
                                    <Sparkles className="w-5 h-5 mr-2 animate-pulse text-yellow-200" />
                                    <span>以 {savedName} 繼續學習</span>
                                    <ChevronRight className="w-5 h-5 ml-2 group-hover:translate-x-1 transition" />
                                </button>
                                <div className="text-center mt-3">
                                    <button onClick={() => { setSavedName(''); LocalDB.clearUser(); }} className="text-xs text-stone-400 hover:text-stone-600 underline">這不是我，切換帳號</button>
                                </div>
                                <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-stone-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-stone-500">或使用新身分</span></div></div>
                            </div>
                        )}

                        <form onSubmit={handleLogin} className={`space-y-4 ${savedName ? 'hidden' : ''}`}>
                            <div>
                                <label className="block text-sm font-medium text-stone-700 mb-1">請輸入您的姓名</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 border border-stone-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="Ex: 王小明" />
                            </div>
                            <button type="submit" disabled={!name.trim()} className="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold hover:bg-orange-700 transition disabled:opacity-50">
                                開始學習
                            </button>
                        </form>
                        
                        <div className={`mt-4 flex items-center justify-between ${savedName ? 'hidden' : ''}`}>
                            <div className="h-px bg-stone-200 flex-1"></div><span className="text-sm text-stone-400 px-2">或</span><div className="h-px bg-stone-200 flex-1"></div>
                        </div>
                        <button onClick={handleQuickLogin} className={`mt-4 w-full bg-stone-50 border-2 border-stone-200 text-stone-600 py-3 rounded-lg font-semibold hover:bg-stone-100 transition flex items-center justify-center ${savedName ? 'hidden' : ''}`}>
                            <Zap className="w-5 h-5 mr-2 text-yellow-500" /> 快速體驗 (免輸入姓名)
                        </button>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout, onNavigate }) => {
            return (
                <div className="p-6 max-w-4xl mx-auto space-y-6">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-stone-800">歡迎回來，{user.displayName || "同學"}</h1>
                            <p className="text-stone-500">準備好開始今天的學習了嗎？</p>
                        </div>
                        <button onClick={onLogout} className="text-stone-500 hover:text-red-500 flex items-center">
                            <LogOut className="w-6 h-6 mr-1" /> <span className="text-sm">登出</span>
                        </button>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* 學習介面 - 保持原樣 */}
                        <button onClick={() => onNavigate('learn')} className="bg-white p-6 rounded-2xl shadow-md hover:shadow-lg transition group border-l-4 border-orange-500 text-left h-full">
                            <div className="flex items-center space-x-4 mb-2">
                                <div className="bg-orange-100 p-3 rounded-full group-hover:bg-orange-200 transition"><BookOpen className="w-8 h-8 text-orange-600" /></div>
                                <h2 className="text-xl font-bold text-stone-800">進入學習介面</h2>
                            </div>
                            <p className="text-stone-500 pl-16">瀏覽重點筆記、形音義、史記體例與成語典故。</p>
                        </button>

                        {/* 測驗介面 - 拆分為兩個按鈕 */}
                        <div className="flex flex-col gap-4">
                            <button onClick={() => onNavigate('quiz_setup')} className="bg-white p-5 rounded-2xl shadow-md hover:shadow-lg transition group border-l-4 border-amber-500 text-left flex-1">
                                <div className="flex items-center space-x-4">
                                    <div className="bg-amber-100 p-3 rounded-full group-hover:bg-amber-200 transition"><PenTool className="w-6 h-6 text-amber-600" /></div>
                                    <div>
                                        <h2 className="text-lg font-bold text-stone-800">一般測驗 (逐題)</h2>
                                        <p className="text-stone-500 text-sm">單元分類、完整計分與詳解。</p>
                                    </div>
                                </div>
                            </button>

                            <button onClick={() => onNavigate('quick_quiz')} className="bg-white p-5 rounded-2xl shadow-md hover:shadow-lg transition group border-l-4 border-sky-500 text-left flex-1">
                                <div className="flex items-center space-x-4">
                                    <div className="bg-sky-100 p-3 rounded-full group-hover:bg-sky-200 transition"><ListChecks className="w-6 h-6 text-sky-600" /></div>
                                    <div>
                                        <h2 className="text-lg font-bold text-stone-800">快速測驗 (刷題)</h2>
                                        <p className="text-stone-500 text-sm">列表模式、即時回饋、錯題速記。</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-4 mt-8">
                        <button onClick={() => onNavigate('history')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <History className="w-6 h-6 text-orange-500 mb-2" /><span className="text-sm font-medium text-stone-700">測驗紀錄</span>
                        </button>
                        <button onClick={() => onNavigate('mistakes')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <AlertCircle className="w-6 h-6 text-red-500 mb-2" /><span className="text-sm font-medium text-stone-700">錯題本</span>
                        </button>
                        <button onClick={() => onNavigate('favorites')} className="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center hover:bg-stone-50 transition">
                            <Heart className="w-6 h-6 text-rose-500 mb-2" /><span className="text-sm font-medium text-stone-700">題目收藏</span>
                        </button>
                    </div>
                </div>
            );
        };

        const LearningModule = ({ onBack }) => {
            const [activeTab, setActiveTab] = useState('intro'); 
            
            const tabs = [
                { id: 'intro', label: '形音義與題解' },
                { id: 'shiji', label: '史記體例' },
                { id: 'idioms', label: '成語典故' },
                { id: 'grammar', label: '詞語語法' },
                { id: 'honorifics', label: '敬謙詞' },
            ];

            // Helper to render image or placeholder
            const renderImage = (src, alt) => {
                if (!src) return null;
                
                return (
                    <div className="mt-4 border-t border-dashed border-stone-200 pt-4">
                        <div className="relative group">
                            <img 
                                src={src} 
                                alt={alt} 
                                className="w-full h-auto rounded-lg shadow-sm" 
                                onError={(e) => {
                                    e.target.style.display = 'none';
                                    e.target.nextSibling.style.display = 'flex'; // Show fallback
                                }}
                            />
                            <div className="hidden flex-col items-center justify-center p-8 bg-stone-50 border-2 border-dashed border-stone-300 rounded-lg text-stone-400">
                                <ImageOff className="w-8 h-8 mb-2" />
                                <span className="text-sm">圖片未找到 ({src})</span>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center justify-between sticky top-0 z-10">
                        <div className="flex items-center">
                            <button onClick={onBack} className="flex items-center text-stone-600 hover:text-orange-600">
                                <ArrowLeft className="w-5 h-5 mr-1" /> 返回
                            </button>
                            <div className="w-4"></div>
                            <h2 className="font-bold text-lg text-stone-800 hidden md:block">學習重點</h2>
                        </div>
                    </div>
                    
                    <div className="flex overflow-x-auto bg-stone-50 px-2 py-2 gap-2 sticky top-14 z-10 border-b">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${
                                    activeTab === tab.id 
                                        ? 'bg-orange-600 text-white shadow-md' 
                                        : 'bg-white text-stone-600 hover:bg-orange-50 border border-stone-200'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 md:p-6 bg-stone-100 pb-20">
                        <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-sm p-6 min-h-[500px]">
                            
                            {activeTab === 'intro' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.intro.title}</h3>
                                    <ul className="space-y-4">
                                        {STUDY_CONTENT.intro.items.map((item, i) => (
                                            <li key={i} className="bg-orange-50 p-4 rounded-lg border border-orange-100">
                                                <span className="font-bold text-orange-700 text-lg mr-2">{item.term}</span>
                                                <span className="text-stone-700">{item.definition}</span>
                                            </li>
                                        ))}
                                    </ul>
                                    <div className="mt-8">
                                        <h4 className="font-bold text-xl text-stone-800 mb-3">{STUDY_CONTENT.intro.author.title}</h4>
                                        <div className="bg-stone-50 p-4 rounded-lg border-l-4 border-stone-400">
                                            <p className="mb-4 text-stone-700 leading-relaxed">{STUDY_CONTENT.intro.author.motivation}</p>
                                            <ul className="list-disc pl-5 space-y-2 text-stone-600 mb-4">
                                                {STUDY_CONTENT.intro.author.stages.map((stage, i) => <li key={i}>{stage}</li>)}
                                            </ul>
                                            {STUDY_CONTENT.intro.author.extra && (
                                                <div className="mt-4 p-3 bg-white rounded border border-stone-200 text-stone-600 text-sm">
                                                    {STUDY_CONTENT.intro.author.extra}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'shiji' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.shiji.title}</h3>
                                    <p className="text-stone-600">{STUDY_CONTENT.shiji.description}</p>
                                    
                                    <div className="grid gap-6">
                                        {STUDY_CONTENT.shiji.table.map((row, i) => (
                                            <div key={i} className="border border-stone-200 rounded-xl p-5 hover:shadow-md transition bg-white overflow-hidden">
                                                <div className="flex justify-between items-center mb-2">
                                                    <h4 className="font-bold text-xl text-indigo-700">{row.category}</h4>
                                                    <span className="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-bold">{row.count}</span>
                                                </div>
                                                <p className="text-stone-700 mb-3 leading-relaxed">{row.content}</p>
                                                {row.note !== "—" && (
                                                    <div className="text-sm text-stone-500 bg-stone-50 p-3 rounded mb-4 border-l-2 border-indigo-200 leading-relaxed">
                                                        <span className="font-bold text-indigo-600 block mb-1">備註：</span>{row.note}
                                                    </div>
                                                )}
                                                {renderImage(row.image, row.category)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'idioms' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.idioms.title}</h3>
                                    <div className="grid gap-6">
                                        {STUDY_CONTENT.idioms.items.map((item, i) => (
                                            <div key={i} className="border border-stone-200 rounded-xl p-5 hover:shadow-md transition bg-white overflow-hidden">
                                                <h4 className="font-bold text-xl text-emerald-700 mb-2">{item.name}</h4>
                                                <p className="text-stone-700 mb-3 text-lg">{item.mean}</p>
                                                <div className="text-sm text-stone-500 bg-stone-50 p-3 rounded mb-4 border-l-2 border-emerald-200 italic">
                                                    出處：{item.source}
                                                </div>
                                                {renderImage(item.image, item.name)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'grammar' && (
                                <div className="space-y-6">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.grammar.title}</h3>
                                    <div className="grid gap-4">
                                        {STUDY_CONTENT.grammar.items.map((item, i) => (
                                            <div key={i} className="border border-stone-200 rounded-xl p-5 hover:shadow-md transition bg-white overflow-hidden">
                                                <div className="flex flex-col">
                                                    <div className="font-bold text-lg text-stone-800 mb-2">{item.text}</div>
                                                    <div className="text-orange-600 font-medium pl-4 border-l-2 border-orange-200">
                                                        {item.mean}
                                                    </div>
                                                </div>
                                                {renderImage(item.image, item.text)}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'honorifics' && (
                                <div className="space-y-8">
                                    <h3 className="text-2xl font-bold text-stone-800 border-b pb-2">{STUDY_CONTENT.honorifics.title}</h3>
                                    <div className="bg-amber-50 p-4 rounded-lg text-amber-900 text-sm leading-relaxed border border-amber-100">
                                        {STUDY_CONTENT.honorifics.intro}
                                    </div>
                                    
                                    <div>
                                        <h4 className="text-lg font-bold text-orange-700 mb-3 flex items-center bg-orange-50 p-2 rounded w-fit">
                                            <User className="w-5 h-5 mr-2"/> 敬詞 (稱呼對方)
                                        </h4>
                                        <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                                            {STUDY_CONTENT.honorifics.respect.map((row, i) => (
                                                <div key={i} className="flex border-b last:border-0 hover:bg-stone-50 transition">
                                                    <div className="w-20 bg-orange-50 p-4 flex items-center justify-center font-bold text-orange-800 text-lg border-r border-orange-100">{row.key}</div>
                                                    <div className="p-4 flex-1 text-stone-700 flex items-center">{row.words}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-lg font-bold text-emerald-700 mb-3 flex items-center bg-emerald-50 p-2 rounded w-fit">
                                            <User className="w-5 h-5 mr-2"/> 謙詞 (稱呼自己)
                                        </h4>
                                        <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                                            {STUDY_CONTENT.honorifics.humble.map((row, i) => (
                                                <div key={i} className="flex border-b last:border-0 hover:bg-stone-50 transition">
                                                    <div className="w-20 bg-emerald-50 p-4 flex items-center justify-center font-bold text-emerald-800 text-lg border-r border-emerald-100">{row.key}</div>
                                                    <div className="p-4 flex-1 text-stone-700 flex items-center">{row.words}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const FullQuizModule = ({ user, onBack, onComplete }) => {
            const [selectedCategory, setSelectedCategory] = useState(null); 
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [favorites, setFavorites] = useState(new Set());
            const [questions, setQuestions] = useState([]);
            const [isAnswered, setIsAnswered] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (!selectedCategory) return;
                let filtered = [...ALL_QUESTIONS];
                if (selectedCategory !== 'all') {
                    filtered = filtered.filter(q => q.category === selectedCategory);
                }
                filtered = filtered.sort(() => 0.5 - Math.random());
                setQuestions(filtered);
                setCurrentQuestionIndex(0);
                setAnswers({});
                setIsAnswered(false);
            }, [selectedCategory]);

            useEffect(() => {
                const favSet = LocalDB.getFavorites();
                const intSet = new Set(Array.from(favSet).map(id => parseInt(id)));
                setFavorites(intSet);
            }, []);

            const toggleFavorite = (qId) => {
                const newFavs = LocalDB.toggleFavorite(qId);
                const intSet = new Set(Array.from(newFavs).map(id => parseInt(id)));
                setFavorites(intSet);
            };

            const handleAnswer = (option) => {
                if (isAnswered) return; 
                const currentQ = questions[currentQuestionIndex];
                const isCorrect = option === currentQ.answer;
                setAnswers(prev => ({ ...prev, [currentQ.id]: option }));
                setIsAnswered(true);
                if (isCorrect) {
                    playSound('correct');
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 2500);
                } else {
                    playSound('incorrect');
                }
            };

            const handleSubmit = () => {
                if (isSubmitting) return; 
                setIsSubmitting(true);
                try {
                    let score = 0;
                    const details = questions.map(q => {
                        const isCorrect = answers[q.id] === q.answer;
                        if (isCorrect) score += 1;
                        return {
                            id: q.id,
                            question: q.question,
                            userAnswer: answers[q.id],
                            correctAnswer: q.answer,
                            isCorrect,
                            options: q.options,
                            category: q.category
                        };
                    });
                    
                    // Save to local history
                    LocalDB.addHistory({
                        score: Math.round((score / questions.length) * 100),
                        total: questions.length,
                        category: selectedCategory === 'all' ? '綜合挑戰' : selectedCategory,
                        details: details
                    });

                    // Save mistakes
                    for (const detail of details) {
                        if (!detail.isCorrect) {
                            LocalDB.addMistake({
                                id: detail.id,
                                question: detail.question,
                                answer: detail.correctAnswer,
                                category: detail.category
                            });
                        }
                    }

                    onComplete({ score: Math.round((score / questions.length) * 100), details });
                } catch (error) {
                    console.error(error);
                    alert("儲存成績時發生錯誤");
                    setIsSubmitting(false); 
                }
            };

            if (!selectedCategory) {
                const categories = [
                    { id: '形音義與題解', label: '形音義與題解', icon: <PenTool className="w-6 h-6 text-blue-500"/>, desc: '字音字形、題解與作者背景' },
                    { id: '史記體例表格', label: '史記體例表格', icon: <LayoutGrid className="w-6 h-6 text-purple-500"/>, desc: '本紀、世家、列傳等體例分類' },
                    { id: '成語典故', label: '成語典故', icon: <BookOpen className="w-6 h-6 text-emerald-500"/>, desc: '源自史記的著名成語與典故' },
                    { id: '課文詞語與語法', label: '課文詞語與語法', icon: <Layers className="w-6 h-6 text-orange-500"/>, desc: '課文中的重要實詞、虛詞與修辭' },
                    { id: '敬詞謙詞對照表', label: '敬詞謙詞對照表', icon: <User className="w-6 h-6 text-pink-500"/>, desc: '古代常見的敬語與謙稱用法' },
                    { id: 'all', label: '全範圍綜合挑戰', icon: <Zap className="w-6 h-6 text-yellow-500"/>, desc: '包含以上所有單元的綜合測驗', isAll: true },
                ];
                return (
                    <div className="h-full flex flex-col bg-stone-50">
                        <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center sticky top-0 z-10"><button onClick={onBack} className="flex items-center text-stone-600 hover:text-orange-600 mr-4"><ArrowLeft className="w-5 h-5 mr-1" /> 返回</button><h2 className="font-bold text-lg text-stone-800">選擇測驗單元</h2></div>
                        <div className="p-6 overflow-y-auto"><div className="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">{categories.map(cat => (<button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`text-left p-6 rounded-2xl shadow-sm border-2 transition hover:shadow-md flex items-start ${cat.isAll ? 'bg-gradient-to-br from-yellow-50 to-orange-50 border-yellow-200 hover:border-yellow-400' : 'bg-white border-stone-100 hover:border-orange-200'}`}><div className={`p-3 rounded-full mr-4 ${cat.isAll ? 'bg-white shadow-sm' : 'bg-stone-50'}`}>{cat.icon}</div><div><h3 className={`font-bold text-lg mb-1 ${cat.isAll ? 'text-yellow-800' : 'text-stone-800'}`}>{cat.label}</h3><p className="text-sm text-stone-500">{cat.desc}</p></div></button>))}</div></div>
                    </div>
                );
            }

            if (questions.length === 0) return <LoadingScreen />;
            const currentQ = questions[currentQuestionIndex];
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            
            return (
                <div className="h-full flex flex-col bg-stone-50 relative">
                    {showConfetti && <Confetti />}
                    <div className="bg-white shadow-sm px-4 py-3 flex items-center justify-between z-10">
                        <div className="flex items-center"><button onClick={onBack} className="flex items-center text-stone-500 hover:text-orange-600 mr-4 px-3 py-1 rounded-full hover:bg-stone-50 transition border border-transparent hover:border-stone-200"><Home className="w-4 h-4 mr-1" /> <span className="text-sm font-medium">首頁</span></button><div className="flex items-center text-stone-500 border-l pl-4"><span className="font-mono text-lg font-bold text-orange-600 mr-2">{currentQuestionIndex + 1}</span><span className="text-sm">/ {questions.length}</span></div></div>
                        <div className="flex-1 mx-4 h-2 bg-stone-200 rounded-full overflow-hidden max-w-xs md:max-w-md hidden md:block"><div className="h-full bg-orange-500 transition-all duration-300" style={{ width: `${progress}%` }}></div></div>
                        <button onClick={() => toggleFavorite(currentQ.id)} className={`p-2 rounded-full hover:bg-stone-100 transition`}><Heart className={`w-6 h-6 transition-colors duration-300 ${favorites.has(currentQ.id) ? 'fill-rose-500 text-rose-500' : 'text-stone-400'}`} /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 flex flex-col items-center">
                        <div className="w-full max-w-2xl flex-1">
                            <div className="bg-white rounded-2xl shadow-lg p-6 md:p-10 mb-6 relative">
                                <span className="inline-block px-3 py-1 bg-orange-100 text-orange-700 text-xs font-bold rounded-full mb-4">{currentQ.category}</span>
                                <h3 className="text-xl md:text-2xl font-bold text-stone-800 mb-8 leading-relaxed">{currentQ.question}</h3>
                                <div className="space-y-3">{currentQ.options.map((opt, i) => {
                                    let statusClass = "border-stone-100 hover:border-stone-300 text-stone-700";
                                    if (isAnswered) { if (opt === currentQ.answer) { statusClass = "border-emerald-500 bg-emerald-50 text-emerald-900 font-bold"; } else if (opt === answers[currentQ.id]) { statusClass = "border-red-500 bg-red-50 text-red-900"; } else { statusClass = "border-stone-100 opacity-50"; } }
                                    return (<button key={i} onClick={() => handleAnswer(opt)} disabled={isAnswered} className={`w-full text-left p-5 rounded-xl border-2 transition relative text-lg font-medium ${statusClass}`}><span className="inline-block w-6 font-bold text-stone-400 mr-2">{String.fromCharCode(65 + i)}.</span>{opt}{isAnswered && opt === currentQ.answer && <CheckCircle className="w-5 h-5 text-emerald-600 absolute right-4 top-1/2 -translate-y-1/2" />}{isAnswered && opt === answers[currentQ.id] && opt !== currentQ.answer && <XCircle className="w-5 h-5 text-red-600 absolute right-4 top-1/2 -translate-y-1/2" />}</button>);
                                })}</div>
                            </div>
                            {isAnswered && (<div className={`rounded-xl p-6 mb-6 animate-fade-in ${answers[currentQ.id] === currentQ.answer ? 'bg-emerald-100 text-emerald-900' : 'bg-red-50 text-red-900'}`}><div className="flex items-center mb-2 font-bold text-lg">{answers[currentQ.id] === currentQ.answer ? <><CheckCircle className="w-6 h-6 mr-2" /> 答對了！</> : <><XCircle className="w-6 h-6 mr-2" /> 答錯了！</>}</div><div className="mt-4 text-xl"><span className="font-bold">正確答案：</span> {currentQ.answer}<div className="mt-3 text-stone-700 text-lg leading-relaxed">此題出自 <span className="font-semibold">{currentQ.category}</span> 章節。建議複習相關筆記以加深印象。</div></div></div>)}
                        </div>
                    </div>
                    <div className="bg-white p-4 border-t flex justify-between items-center z-10 sticky bottom-0">
                        <div className="w-24"></div> 
                        {isAnswered ? (currentQuestionIndex < questions.length - 1 ? (<button onClick={() => { setIsAnswered(false); setShowConfetti(false); setCurrentQuestionIndex(c => c + 1); }} className="px-8 py-3 bg-stone-800 text-white rounded-full hover:bg-stone-700 transition font-bold shadow-lg flex items-center animate-bounce-subtle">下一題 <ChevronRight className="w-5 h-5 ml-1" /></button>) : (<button onClick={handleSubmit} disabled={isSubmitting} className="px-8 py-3 bg-orange-600 text-white rounded-full hover:bg-orange-700 transition font-bold shadow-lg shadow-orange-200 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">{isSubmitting ? <><Loader2 className="w-5 h-5 mr-2 animate-spin" /> 處理中...</> : <>查看總成績 <CheckCircle className="w-5 h-5 ml-2" /></>}</button>)) : (<div className="text-stone-400 text-sm italic">請選擇一個答案以繼續</div>)}<div className="w-24"></div>
                    </div>
                </div>
            );
        };

        const QuickQuizModule = ({ onBack }) => {
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            const [score, setScore] = useState(0);
            const [showConfetti, setShowConfetti] = useState(false);

            useEffect(() => {
                // Randomize all questions for quick mode
                const shuffled = [...ALL_QUESTIONS].sort(() => 0.5 - Math.random());
                setQuestions(shuffled);
            }, []);

            const handleAnswer = (q, option) => {
                if (answers[q.id]) return; // Already answered

                const isCorrect = option === q.answer;
                setAnswers(prev => ({ ...prev, [q.id]: option }));

                if (isCorrect) {
                    setScore(s => s + 1);
                    playSound('correct');
                    setShowConfetti(true);
                    setTimeout(() => setShowConfetti(false), 1500);
                } else {
                    playSound('incorrect');
                    // Instant add to mistakes
                    LocalDB.addMistake({
                        id: q.id,
                        question: q.question,
                        answer: q.answer,
                        category: q.category
                    });
                }
            };

            return (
                <div className="h-full flex flex-col bg-stone-50 relative">
                    {showConfetti && <Confetti />}
                    
                    {/* Header with Scoreboard */}
                    <div className="bg-white shadow-md border-b px-4 py-3 flex items-center justify-between sticky top-0 z-20">
                        <button onClick={onBack} className="flex items-center text-stone-600 hover:text-sky-600">
                            <ArrowLeft className="w-5 h-5 mr-1" /> 退出
                        </button>
                        
                        <div className="flex items-center space-x-4">
                            <div className="flex items-center bg-sky-50 px-3 py-1 rounded-full border border-sky-100">
                                <Trophy className="w-4 h-4 text-sky-500 mr-2" />
                                <span className="font-bold text-sky-700">{score}</span>
                                <span className="text-stone-400 text-xs ml-1">答對</span>
                            </div>
                        </div>
                    </div>

                    {/* Scrollable Question List */}
                    <div className="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                        <div className="max-w-3xl mx-auto space-y-6">
                            {questions.map((q, index) => {
                                const userAnswer = answers[q.id];
                                const isAnswered = userAnswer !== undefined;
                                const isCorrect = userAnswer === q.answer;

                                return (
                                    <div key={q.id} className={`bg-white rounded-xl shadow-sm border p-6 transition duration-300 ${isAnswered ? (isCorrect ? 'border-emerald-200 bg-emerald-50/30' : 'border-red-200 bg-red-50/30') : 'border-stone-100 hover:shadow-md'}`}>
                                        <div className="flex justify-between items-start mb-4">
                                            <span className="text-xs font-bold text-stone-500 bg-stone-100 px-2 py-1 rounded">{q.category}</span>
                                            <span className="text-stone-300 font-mono text-sm">#{index + 1}</span>
                                        </div>
                                        
                                        <h3 className="text-lg font-bold text-stone-800 mb-4">{q.question}</h3>
                                        
                                        <div className="grid grid-cols-1 gap-2">
                                            {q.options.map((opt, i) => {
                                                let btnClass = "text-left px-4 py-3 rounded-lg border text-sm font-medium transition relative ";
                                                
                                                if (isAnswered) {
                                                    if (opt === q.answer) {
                                                        btnClass += "bg-emerald-500 text-white border-emerald-600 shadow-sm";
                                                    } else if (opt === userAnswer) {
                                                        btnClass += "bg-red-500 text-white border-red-600 shadow-sm";
                                                    } else {
                                                        btnClass += "bg-white text-stone-400 border-stone-100 opacity-60";
                                                    }
                                                } else {
                                                    btnClass += "bg-white text-stone-700 border-stone-200 hover:bg-sky-50 hover:border-sky-200 hover:text-sky-700";
                                                }

                                                return (
                                                    <button 
                                                        key={i} 
                                                        onClick={() => handleAnswer(q, opt)}
                                                        disabled={isAnswered}
                                                        className={btnClass}
                                                    >
                                                        <span className="mr-2 opacity-70">{String.fromCharCode(65 + i)}.</span>
                                                        {opt}
                                                        {isAnswered && opt === q.answer && <CheckCircle className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4" />}
                                                        {isAnswered && opt === userAnswer && opt !== q.answer && <XCircle className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4" />}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                            
                            <div className="text-center py-8 text-stone-400 text-sm">
                                已經到底了！
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ResultReview = ({ result, onExit }) => {
            return (
                <div className="h-full bg-stone-50 overflow-y-auto">
                    <div className="max-w-3xl mx-auto p-6">
                        <div className="bg-white rounded-3xl shadow-lg p-8 mb-8 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-orange-500 to-amber-500"></div>
                            <h2 className="text-3xl font-bold text-stone-800 mb-2">測驗結果</h2>
                            <div className="text-6xl font-black text-orange-600 my-4">{result.score}<span className="text-2xl text-stone-400 font-normal">分</span></div>
                            <div className="flex justify-center gap-4 text-sm text-stone-500">
                                <span>總題數: {result.details.length}</span>
                                <span className="text-green-600">答對: {result.details.filter(d => d.isCorrect).length}</span>
                                <span className="text-red-500">答錯: {result.details.filter(d => !d.isCorrect).length}</span>
                            </div>
                            <button onClick={onExit} className="mt-8 px-8 py-2 border border-stone-300 rounded-full hover:bg-stone-50 transition">
                                返回首頁
                            </button>
                        </div>

                        <h3 className="text-xl font-bold text-stone-800 mb-4 px-2">試題解析</h3>
                        <div className="space-y-4">
                            {result.details.map((item, i) => (
                                <div key={i} className={`bg-white rounded-xl shadow-sm p-6 border-l-4 ${item.isCorrect ? 'border-emerald-500' : 'border-red-500'}`}>
                                    <div className="flex items-start justify-between mb-3">
                                        <h4 className="font-bold text-lg text-stone-800 flex-1">{i + 1}. {item.question}</h4>
                                        {item.isCorrect 
                                            ? <CheckCircle className="w-6 h-6 text-emerald-500 flex-shrink-0" />
                                            : <XCircle className="w-6 h-6 text-red-500 flex-shrink-0" />
                                        }
                                    </div>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex items-center">
                                            <span className="w-20 text-stone-500">您的答案：</span>
                                            <span className={`font-bold ${item.isCorrect ? 'text-emerald-700' : 'text-red-600'}`}>
                                                {item.userAnswer || '(未作答)'}
                                            </span>
                                        </div>
                                        {!item.isCorrect && (
                                            <div className="flex items-center">
                                                <span className="w-20 text-stone-500">正確答案：</span>
                                                <span className="font-bold text-emerald-700">{item.correctAnswer}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ListView = ({ title, type, user, onBack }) => {
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [expandedId, setExpandedId] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    let data = [];
                    
                    if (type === 'history') {
                        data = LocalDB.getHistory();
                    } else if (type === 'mistakes') {
                        data = LocalDB.getMistakes();
                    } else if (type === 'favorites') {
                        const favSet = LocalDB.getFavorites();
                        const favIds = Array.from(favSet).map(id => parseInt(id));
                        data = ALL_QUESTIONS.filter(q => favIds.includes(q.id));
                    }

                    setItems(data);
                    setLoading(false);
                };
                fetchData();
            }, [user, type]);

            if (loading) return <LoadingScreen />;

            return (
                <div className="h-full bg-stone-50 flex flex-col">
                    <div className="bg-white shadow-sm border-b px-4 py-3 flex items-center sticky top-0 z-10">
                        <button onClick={onBack} className="flex items-center text-stone-600 hover:text-orange-600 mr-4">
                            <ArrowLeft className="w-5 h-5 mr-1" /> 返回
                        </button>
                        <h2 className="font-bold text-lg">{title}</h2>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 md:p-6">
                        <div className="max-w-3xl mx-auto space-y-4">
                            {items.length === 0 && (
                                <div className="text-center py-20 text-stone-400">
                                    <p>目前沒有紀錄</p>
                                </div>
                            )}

                            {/* History Item */}
                            {type === 'history' && items.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm hover:shadow-md transition">
                                    <div 
                                        className="flex justify-between items-center cursor-pointer" 
                                        onClick={() => setExpandedId(expandedId === item.id ? null : item.id)}
                                    >
                                        <div>
                                            <div className="text-stone-500 text-xs mb-1">
                                                {item.date ? new Date(item.date).toLocaleString() : 'Just now'}
                                            </div>
                                            <div className="font-bold text-stone-800 flex items-center">
                                                <span className="mr-2 text-sm bg-stone-100 px-2 py-0.5 rounded text-stone-600">
                                                    {item.category || '綜合挑戰'}
                                                </span>
                                                測驗得分：
                                                <span className={`text-lg ml-1 ${item.score >= 80 ? 'text-emerald-600' : 'text-orange-600'}`}>
                                                    {item.score}
                                                </span> 分
                                            </div>
                                        </div>
                                        {expandedId === item.id ? (
                                            <ChevronUp className="w-5 h-5 text-stone-400" />
                                        ) : (
                                            <ChevronDown className="w-5 h-5 text-stone-400" />
                                        )}
                                    </div>
                                    
                                    {/* Enhanced Detail View for History */}
                                    {expandedId === item.id && (
                                        <div className="mt-4 pt-4 border-t border-stone-100 space-y-4">
                                            {item.details.map((d, i) => (
                                                <div key={i} className="bg-stone-50 p-4 rounded-lg border border-stone-200">
                                                    {/* Question Header */}
                                                    <div className="flex items-start mb-3">
                                                        <span className="font-mono font-bold text-orange-600 mr-2 mt-0.5">{i+1}.</span>
                                                        <h4 className="font-bold text-stone-800 text-lg leading-snug flex-1">
                                                            {d.question}
                                                        </h4>
                                                        {d.isCorrect 
                                                            ? <CheckCircle className="w-5 h-5 text-emerald-500 flex-shrink-0 ml-2" />
                                                            : <XCircle className="w-5 h-5 text-red-500 flex-shrink-0 ml-2" />
                                                        }
                                                    </div>

                                                    {/* Options Display */}
                                                    <div className="space-y-1 mb-3 pl-6">
                                                        {d.options && d.options.map((opt, idx) => {
                                                            let optionStyle = "text-stone-600";
                                                            let icon = null;

                                                            if (opt === d.correctAnswer) {
                                                                optionStyle = "bg-emerald-100 text-emerald-800 font-bold border-emerald-200";
                                                                icon = <CheckCircle className="w-4 h-4 ml-2 inline" />;
                                                            } else if (opt === d.userAnswer && !d.isCorrect) {
                                                                optionStyle = "bg-red-50 text-red-800 line-through border-red-100";
                                                                icon = <XCircle className="w-4 h-4 ml-2 inline" />;
                                                            }

                                                            return (
                                                                <div key={idx} className={`px-3 py-2 rounded text-sm border border-transparent ${optionStyle} flex items-center`}>
                                                                    <span className="font-mono w-5 opacity-50 mr-1">{String.fromCharCode(65 + idx)}.</span>
                                                                    <span className="flex-1">{opt}</span>
                                                                    {icon}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>

                                                    {/* Analysis / Feedback Section */}
                                                    <div className="bg-white p-3 rounded border border-stone-100 text-sm mt-2 pl-6 relative">
                                                        <div className="absolute left-0 top-0 bottom-0 w-1 bg-orange-400 rounded-l"></div>
                                                        <div className="flex flex-col sm:flex-row gap-y-1 sm:gap-x-6 text-sm mb-1">
                                                            <div>
                                                                <span className="text-stone-400 mr-2">您的作答:</span>
                                                                <span className={`font-bold ${d.isCorrect ? 'text-emerald-600' : 'text-red-600'}`}>
                                                                    {d.userAnswer || '未作答'}
                                                                </span>
                                                            </div>
                                                            {!d.isCorrect && (
                                                                <div>
                                                                    <span className="text-stone-400 mr-2">正確答案:</span>
                                                                    <span className="font-bold text-emerald-600">{d.correctAnswer}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="text-stone-500 text-xs mt-2 pt-2 border-t border-stone-50">
                                                            <span className="font-bold text-orange-400 mr-1">解析:</span>
                                                            此題屬於「{item.category || '綜合挑戰'}」單元。請複習相關講義內容以加深記憶。
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}

                            {/* Mistakes & Favorites List */}
                            {(type === 'mistakes' || type === 'favorites') && items.map((item) => (
                                <div key={item.id} className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-400">
                                    <div className="flex justify-between mb-3">
                                        <span className="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded">{item.category || (ALL_QUESTIONS.find(q=>q.id === item.id)?.category)}</span>
                                        {type === 'mistakes' ? (
                                            <span className="text-xs text-red-500 font-bold">答錯</span>
                                        ) : (
                                            <Heart className="w-5 h-5 fill-rose-500 text-rose-500" />
                                        )}
                                    </div>
                                    <h3 className="font-bold text-lg text-stone-800 mb-3">{item.question}</h3>
                                    <div className="bg-emerald-50 p-3 rounded text-sm text-emerald-800">
                                        <span className="font-bold">正確答案：</span> {item.answer || (ALL_QUESTIONS.find(q=>q.id === item.id)?.answer)}
                                    </div>
                                    
                                    {/* Controls for removal */}
                                    <div className="mt-4 flex justify-end">
                                        {type === 'mistakes' && (
                                            <button 
                                                onClick={(e) => {
                                                    e.target.innerText = "已移除";
                                                    e.target.disabled = true;
                                                    LocalDB.removeMistake(item.id);
                                                }}
                                                className="text-sm text-stone-400 hover:text-red-500 flex items-center"
                                            >
                                                <CheckCircle className="w-4 h-4 mr-1"/> 我學會了（移除）
                                            </button>
                                        )}
                                        {type === 'favorites' && (
                                            <button 
                                                onClick={(e) => {
                                                    e.target.innerText = "已取消收藏";
                                                    e.target.disabled = true;
                                                    LocalDB.removeFavorite(item.id);
                                                }}
                                                className="text-sm text-stone-400 hover:text-red-500 flex items-center"
                                            >
                                                <Heart className="w-4 h-4 mr-1"/> 取消收藏
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('auth'); 
            const [loading, setLoading] = useState(true);
            const [quizResult, setQuizResult] = useState(null);

            useEffect(() => {
                const checkLogin = () => {
                    const savedUser = LocalDB.getUser();
                    if (savedUser) {
                        setUser(savedUser);
                        setView('dashboard');
                    } else {
                        setUser(null);
                        setView('auth');
                    }
                    setLoading(false);
                };
                checkLogin();
            }, []);

            if (loading) return <LoadingScreen />;

            if (view === 'auth') return <AuthScreen onLogin={(u) => { setUser(u); setView('dashboard'); }} />;
            if (view === 'dashboard') return <Dashboard user={user} onLogout={() => { setUser(null); setView('auth'); }} onNavigate={setView} />;
            if (view === 'learn') return <LearningModule onBack={() => setView('dashboard')} />;
            if (view === 'quiz_setup') {
                return <FullQuizModule user={user} onBack={() => setView('dashboard')} onComplete={(res) => { setQuizResult(res); setView('quiz_result'); }} />;
            }
            if (view === 'quick_quiz') return <QuickQuizModule onBack={() => setView('dashboard')} />;
            if (view === 'quiz_result') return <ResultReview result={quizResult} onExit={() => setView('dashboard')} />;
            if (view === 'history') return <ListView title="測驗歷史紀錄" type="history" user={user} onBack={() => setView('dashboard')} />;
            if (view === 'mistakes') return <ListView title="錯題本 (尚未掌握)" type="mistakes" user={user} onBack={() => setView('dashboard')} />;
            if (view === 'favorites') return <ListView title="我的題目收藏" type="favorites" user={user} onBack={() => setView('dashboard')} />;

            return <div className="p-4 text-center">未知頁面</div>;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>